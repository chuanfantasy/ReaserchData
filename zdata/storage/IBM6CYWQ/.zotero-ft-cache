单位代码： 10293 密 级：
专 业 学 位 硕 士 论 文

论文题目： 基于区块链的珠宝交易溯源系统的研究与实现

学

号

姓

名

导

师

专业学位类别

类

型

专业（领域）

论文提交日期

1219094709 王文豪 宫婧 工程硕士 全日制 物流工程 2022.4

Research and implementation of jewelry transaction traceability system based on
blockchain
Thesis Submitted to Nanjing University of Posts and Telecommunications for the Degree of Master of Engineering
By Wang Wenhao Supervisor: Prof. Gong Jing
April 2022

南京邮电大学学位论文原创性声明
本人声明所呈交的学位论文是我个人在导师指导下进行的研究工作及取得的研究成果。 尽我所知，除了文中特别加以标注和致谢的地方外，论文中不包含其他人已经发表或撰写过 的研究成果，也不包含为获得南京邮电大学或其它教育机构的学位或证书而使用过的材料。 与我一同工作的同志对本研究所做的任何贡献均已在论文中作了明确的说明并表示了谢意。
本人学位论文及涉及相关资料若有不实，愿意承担一切相关的法律责任。
研究生学号： 1219094709 研究生签名：_____________ 日期：2022.04.07
南京邮电大学学位论文使用授权声明
本人承诺所呈交的学位论文不涉及任何国家秘密，本人及导师为本论文的涉密责任并列 第一责任人。
本人授权南京邮电大学可以保留并向国家有关部门或机构送交论文的复印件和电子文档； 允许论文被查阅和借阅；可以将学位论文的全部或部分内容编入有关数据库进行检索；可以 采用影印、缩印或扫描等复制手段保存、汇编本学位论文。本文电子文档的内容和纸质论文 的内容相一致。论文的公布（包括刊登）授权南京邮电大学研究生院办理。
非国家秘密类涉密学位论文在解密后适用本授权书。
研究生签名：____________ 导师签名：____________ 日期： 2022.04.07

摘要
奢侈品珠宝的真伪问题是当今消费行业的重点关注问题，而珠宝交易溯源系统是保障珠 宝品质和真伪的重要手段之一。传统的珠宝交易追溯系统都是依托于某个中心企业服务器进 行的，由于过度的依赖于中心化服务器，如果中心服务器发生了故障或是入侵，储存的数据 就将会流失或是被盗，同时在珠宝贸易流转过程中，由于数据更新共享的延迟也使得贸易信 息无法跟上数据查询的速率。所以，传统的珠宝贸易追溯系统就必须结合最新的信息技术来 处理这些问题。而区块链则是一个把分布式共识、分布式存储等多个新技术相结合，用来进 行去中心化的无信任交易的全新分布式网络结构帐本技术，其特点可用于追溯。所以，本文 中将区块链技术与珠宝贸易的追溯系统进行了整合，并对追溯系统进行了总体设计，并且在 共识效率和查询速度方面进行详细设计，并对系统进行实现和测试。
首先分析了传统实用拜占庭容错共识算法应用于珠宝交易溯源系统中的共识效率低、通 信复杂度高等问题，提出一种基于多层分组的低通信成本实用拜占庭容错共识算法。该算法 首先通过节点属性分组模型将联盟链中结点划分为不同组的共识节点、监督节点，不同属性 的节点被划分在不同的共识组，而组内还会继续分层，不同组的结点在第一层共识后递归向 下层发送共识请求知道共识至末层，这大大降低了节点通信复杂度。其次，末层结合 Raft 共识算法，减少共识时延。最后监督节点负责监督末层 Raft 共识算法中的领导结点，负责 抵抗恶意节点。通过实验证明了基于多层分组的低通信成本实用拜占庭容错共识算法通信复 杂度更低、吞吐量更高、时延更低。
接着分析了传统区块链式结构在珠宝交易溯源系统中的查询效率低下等问题，提出了一 种基于区块链的快速索引算法。在原有区块链系统中，定位区块中交易信息和定位上次交易 区块都需要逐个比对信息，极大影响查询返回速度。该算法首先引入重复索引机制，通过控 制缓存衰减来减少短期内不断查询的访问。其次引入快速定位叶子结点模型来对区块中每个 叶子结点的索引位置和珠宝 id 进行存储，在查询时直接获取索引位置来减少比对时延。最 后，在查询完当前区块后，使用区块距离模型来计算上个交易区块距离实现快速跳转，减少 遍历无用区块的时间消耗。通过实验证明了该算法的返回查询信息的高效性。
最后，将上述的共识算法与快速索引算法应用到基于区块链的珠宝交易溯源系统中，并 且对系统的主要功能模块页面进行了展示和检验，根据检验结果表明该追溯系统能够满足珠 宝交易溯源的使用要求。
关键词: 区块链 ，珠宝溯源 ，共识算法 ，快速查询，索引
I

Abstract
The authenticity of luxury jewelry is the focus of the consumer industry, and the jewelry transaction traceability system is one of the important means to ensure the quality and authenticity of jewelry. The traditional jewelry transaction tracing system relies on a central enterprise server. Due to excessive dependence on the central server, if the central server fails or invades, the stored data will be lost or stolen. At the same time, in the process of jewelry trade circulation, Due to the delay of data update and sharing, trade information can not keep up with the rate of data query. Therefore, the traditional jewelry trade traceability system must be combined with the latest information technology to deal with these problems. Blockchain is a new distributed network structure accounting technology that combines distributed consensus, distributed storage and other new technologies to conduct decentralized untrusted transactions. Its characteristics can be used for traceability. Therefore, this thesis integrates the blockchain technology with the traceability system of jewelry trade, makes an overall design of the traceability system, makes a detailed design in terms of consensus efficiency and query speed, and implements and tests the system.
Firstly, the problems of low consensus efficiency and high communication complexity of traditional practical Byzantine fault-tolerant consensus algorithm applied to jewelry transaction traceability system are analyzed, and a practical Byzantine fault-tolerant consensus algorithm with low communication cost based on multi-layer grouping is proposed. Firstly, through the node attribute grouping model, the nodes in the alliance chain are divided into different groups of consensus nodes and supervision nodes. The nodes with different attributes are divided into different consensus groups, and the group will continue to be layered. After the first layer of consensus, the nodes of different groups return to the lower layer to send consensus requests to know the consensus to the end layer, which greatly reduces the communication complexity of nodes. Secondly, the last layer combines the raft consensus algorithm to reduce the consensus delay. At the end of the node, the leader of the raft is responsible for the supervision of the malicious consensus algorithm. Experiments show that the practical Byzantine fault-tolerant consensus algorithm with low communication cost based on multi-layer packet has lower communication complexity, higher throughput and lower delay.
Then it analyzes the low query efficiency of the traditional blockchain structure in the jewelry transaction traceability system, and puts forward a fast indexing algorithm based on blockchain. In
II

the original blockchain system, the transaction information in the positioning block and the positioning of the last transaction block need to compare the information one by one, which greatly affects the query return speed. Firstly, the algorithm introduces the repeated index mechanism to reduce the access of continuous queries in a short time by controlling the cache attenuation. Secondly, the fast positioning leaf node model is introduced to store the index position and jewelry ID of each leaf node in the block. The index position is obtained directly during query to reduce the comparison delay. Finally, after querying the current block, the block distance model is used to calculate the distance of the last trading block, so as to realize fast jump and reduce the time consumption of traversing useless blocks. Experiments show that the algorithm is efficient in returning query information.
Finally, the above consensus algorithm and fast index algorithm are applied to the jewelry transaction traceability system based on blockchain, and the main function module pages of the system are displayed and tested. The test results show that the traceability system can meet the application requirements of jewelry transaction traceability.
Key words: Blockchain, jewelry traceability, consensus algorithm, quick query, index
III

目录
第一章 绪论 .............................................................................................................................................................. 1 1.1 课题背景及意义 ......................................................................................................................................... 1 1.2 课题来源及研究内容 ................................................................................................................................. 2 1.3 章节安排 ..................................................................................................................................................... 2
第二章 相关技术研究 .............................................................................................................................................. 4 2.1 基础知识 ..................................................................................................................................................... 4 2.1.1 区块链概念 ...................................................................................................................................... 4 2.1.2 Merkle 树.......................................................................................................................................... 6 2.1.3 共识算法 .......................................................................................................................................... 6 2.1.4 智能合约链码 .................................................................................................................................. 7 2.1.5 IPFS 技术介绍.................................................................................................................................. 7 2.2 基于区块链的溯源系统研究与发展 ......................................................................................................... 7 2.2.1 传统的奢侈品珠宝溯源研究现状................................................................................................... 8 2.2.2 基于区块链的其他领域溯源研究现状........................................................................................... 9 2.2.3 小结 ................................................................................................................................................ 10 2.3 基于区块链的奢侈品珠宝溯源研究与发展............................................................................................ 10 2.4 本章小结 ................................................................................................................................................... 12
第三章 基于区块链的珠宝交易溯源系统总体设计............................................................................................. 13 3.1 系统需求分析 ........................................................................................................................................... 13 3.1.1 基于区块链的珠宝交易溯源系统业务流程分析......................................................................... 13 3.1.2 功能需求 ........................................................................................................................................ 15 3.1.3 非功能需求 .................................................................................................................................... 17 3.2 总体架构设计 ........................................................................................................................................... 17 3.2.1 系统架构 ........................................................................................................................................ 17 3.2.2 系统网络部署 ................................................................................................................................ 19 3.3 系统功能设计 ........................................................................................................................................... 20 3.4 数据库设计 ............................................................................................................................................... 23 3.5 本章小结 ................................................................................................................................................... 25
第四章 基于多层分组的低通信成本 PBFT 共识算法 ......................................................................................... 26 4.1 问题分析 ................................................................................................................................................... 26 4.2 基于多层分组的低通信成本 PBFT 共识算法 ........................................................................................ 27 4.2.1 LC-PBFT 共识算法总体设计........................................................................................................ 27 4.2.2 LC-PBFT 共识算法详细设计........................................................................................................ 28 4.2.3 LC-PBFT 共识算法分析................................................................................................................ 33 4.3 LC-PBFT 共识算法实验分析................................................................................................................... 34 4.4 本章小结 ................................................................................................................................................... 40
第五章 基于区块链的珠宝交易溯源系统快速索引算法..................................................................................... 41 5.1 问题分析 ................................................................................................................................................... 41 5.2 基于区块链的珠宝交易溯源系统的快速索引算法................................................................................ 42 5.2.1 基于区块链的快速索引算法总体设计......................................................................................... 42 5.2.2 基于区块链的快速索引算法详细设计......................................................................................... 43 5.2.3 快速索引算法实现流程 ................................................................................................................ 46 5.3 快速索引算法分析 ................................................................................................................................... 51 5.4 本章小结 ................................................................................................................................................... 54
IV

第六章 系统实现与测试 ........................................................................................................................................ 55 6.1 开发环境 ................................................................................................................................................... 55 6.1.1 硬件环境 ........................................................................................................................................ 55 6.1.2 软件环境 ........................................................................................................................................ 55 6.2 环境配置与部署........................................................................................................................................ 56 6.2.1 Hyperledger Fabric 网络环境部署 ................................................................................................ 56 6.2.2 IPFS 部署 ....................................................................................................................................... 57 6.2.3 LC-PBFT 共识算法部署................................................................................................................ 59 6.2.4 智能合约部署 ................................................................................................................................ 60 6.2.5 代码部署 ........................................................................................................................................ 60 6.3 系统功能实现与测试................................................................................................................................ 61 6.3.1 系统功能实现 ................................................................................................................................ 61 6.3.2 系统功能测试 ................................................................................................................................ 67 6.4 本章小结 ................................................................................................................................................... 69
第七章 总结与展望 ................................................................................................................................................ 70 7.1 总结 ........................................................................................................................................................... 70 7.2 展望 ........................................................................................................................................................... 71
参考文献 ................................................................................................................................................................. 72 附录 1 攻读硕士学位期间申请的专利 ................................................................................................................. 75 附录 2 攻读硕士学位期间参加的科研项目 ......................................................................................................... 76 致谢 ......................................................................................................................................................................... 77
V

南京邮电大学专业学位硕士研究生学位论文
第一章 绪论

第一章 绪论

传统的珠宝供应链信息在管理的过程中存在很多问题。例如存储的产品数据不太安全， 很容易被篡改；没有对产品进行监控，质量检查也没有保证；产品执行过程的透明度对终端 消费者非常有限，难以验证产品的真实性。区块链技术的去中心化数据、防篡改机制、多节 点共识、分布式等技术特性非常适用于珠宝供应链信息和交易信息溯源的应用场景。所以在 珠宝交易溯源系统中结合区块链技术解决数据集中化存储、数据易篡改、产品过程不透明等 问题，并且涉及到多次交易珠宝的信息溯源的速度提升也是珠宝交易溯源领域正在研究的课 题。
1.1 课题背景及意义
近年来，随着我国电商平台的发展，商品的电子交易数量不断扩大，而因为进口商品的 高利润、高价值等特点，特别容易导致出现很多仿照者制售假冒品进行销售的现象，而消费 者自己对真品的甄别能力较弱，容易买到赝品，所以需要让消费者可以通过某种途径可以看 清商品正确来源信息来辨别假冒产品；而高税率容易导致违法者产生私运的念头，从而影响 到国内市场的秩序。因此提升高价值奢侈品的溯源信息的准确度和真实度，是整个消费者市 场所需要的。而对于商品溯源方面的解决方法，各企业、政府部门等都一直在研究和完善中， 对珠宝质量监控和管理以及二次交易信息管理也越来越离不开现代化的珠宝交易溯源系统。
珠宝交易溯源系统，就是利用现代化的信息技术把珠宝从原料开始到珠宝的完成，然后 经过经销商到被消费者购买以及多次交易转手的整个过程中珠宝产业链上各个环节的信息进 行记录和追溯。通过整个流转过程上各企业参与的方式，实现珠宝交易数据的共享和传输。 但是在传统的珠宝溯源系统中，供应链数据是保存某一中心机构掌控的数据库中，其信息数 据易被他人盗取和篡改，这会导致消费者获得的溯源信息的真实性无法得到保障，从而出现 真货掉包成假货进行售卖的情况，导致消费者对商家信任度降低，并且珠宝业务流转环节过 多，过程较长，容易产生数据更新不及时等问题，这会在追溯时获取珠宝信息不完整，加大 追溯难度。因此，面对珠宝溯源的真实性和安全性问题上，需要一款新技术方案来解决传统 溯源系统的不足。
区块链技术是一种天生解决信任问题的技术，它具有去中心化、分布式存储、无法篡改、 安全透明等特点，通过共识机制、智能合约等手段来保证互不信任节点之间的可靠通信，区 块链将每次交易数据在每个交易节点上都进行存储使得数据公开透明，并且将数据生成区块
1

南京邮电大学专业学位硕士研究生学位论文

第一章 绪论

形成一条链，方便后期的管理，能够解决传统中心化系统存在的存储数据完全由中心机构控

制的不安全等问题。区块链的不可篡改特性可以在产品出现问题时正确的找到相关的可靠信

息并进行追责相关用户。

本课题实现一套基于区块链的珠宝交易溯源系统。为了解决因区块链系统中节点数量不

断增加带来的通信复杂度和共识效率问题，本文系统构建了一种基于多层分组的低通信成本

共识算法，引入基于节点属性分组、末层 raft 共识等减少了共识过程的通信复杂度和加快共

识速度，提高了系统的共识效率。另一方面，为了保证珠宝查询多次交易产生的多个不连续

区块的溯源速度，该系统对区块链中溯源流程进行研究，提出一种基于区块链的珠宝交易溯

源系统的快速索引算法，引入重复索引机制、快速定位叶子节点模型、区块距离模型，减少

重复溯源时间和遍历无关区块和节点的时间消耗，使得区块链系统的溯源速度大幅提升，从

而提高用户体验。

1.2 课题来源及研究内容

本研究课题来源于导师团队与某企业的合作项目，该项目的要求是设计一个可以使用的 珠宝溯源系统，该系统最主要的功能点的是需要基于区块链技术来实现珠宝溯源系统。项目 聚焦于溯源珠宝信息的速度，从索引间隔、区块内寻找指定节点、区块遍历这三个方向开展 溯源效率问题研究以给用户最好的溯源体验。
本研究课题将区块链技术应用于珠宝交易信息溯源场景之中，首先对珠宝信息溯源研究 现状进行文献调研，了解珠宝交易溯源存在的一些特点，分析了传统珠宝溯源目前存在的问 题，设计了一个基于区块链的珠宝交易溯源系统。接着分析了在本文情景下传统的共识算法 存在共识效率和通信复杂等问题，针对这些问题，本课题设计一种基于多层分组的低通信成 本共识算法。最后分析了现有的基于区块链的溯源系统中存在溯源索引速度的问题，为了加 快索引速度，本课题设计一种基于区块链的珠宝交易快速索引方案。本课题的研究内容可以 实现珠宝以及交易信息可以保真的同时，还可以实现溯源效率。因此，本课题的研究对防伪 等有积极的探索价值。

1.3 章节安排

本文从区块链存储分配以及共识算法研究现状出发，重点针对区块链溯源在存储以及共 识方面的改进开展了深入的学习研究。论文结构安排如下：
第一章 绪论。首先介绍了珠宝交易溯源系统的含义以及研究意义，并介绍区块链技术
2

南京邮电大学专业学位硕士研究生学位论文

第一章 绪论

应用在珠宝交易溯源系统中的优势和必要性。然后简单概述了本课题解决方案。最后说明了

本课题来源及研究内容。

第二章 相关技术研究。首先简要介绍区块链技术的相关概念，阐述了区块链中的共识

机制、默克尔树等，并介绍了珠宝交易溯源系统中涉及到其他技术。其次，对传统珠宝交易

溯源国内外现状进行分析并提出其存在的缺陷，以及分析了基于区块链的其它领域溯源系统

的研究现状。最后，介绍了区块链技术和奢侈品珠宝结合的溯源现状研究。

第三章 基于区块链的珠宝交易溯源系统总体设计。首先对基于区块链的珠宝交易流转

过程进行分析并总结出系统的功能模块需求以及非功能需求，同时构建出基于区块链的珠宝

交易溯源系统的总体架构图以及网络部署图。接着，分析并设计出系统的各个子功能模块并

绘制出其对应的 UML 时序图。最后对系统的数据库进行设计并提供关联结构图以及 E-R 图。

第四章 基于多层分组的低通信成本 PBFT 共识算法。首先分析了针对现有联盟区块链共

识算法应用在珠宝交易溯源这种流转环节较多的大规模区块链网络情景下时，传统的 PBFT

共识算法的不足。然后针对这些不足，提出了一种低通信成本的共识算法，引入了基于节点

属性分层分组模型、多层共识流程对系统共识效率和通信复杂度方面进行优化并给出共识流

程步骤和流程图以及上层共识的伪代码。最后，通过实验证明了该算法的效率比传统的

PBFT 共识算法有不错的提升。

第五章 基于区块链的珠宝交易溯源系统的快速索引方案。对溯源系统中溯源速度问题

进行分析，在此基础上提出一种基于区块链的快速索引方案，通过重复索引机制解决短期内

同一商品多次溯源的不必要重复性索引操作问题。通过快速定位叶子节点模型解决进入区块

后查找匹配的商品交易信息逐个比对 merkle 树叶子节点所浪费的时间问题。通过区块距离

模型解决定位上次交易时进入大量无关区块问题。

第六章 系统实现与测试。首先对区块链珠宝交易溯源系统进行搭建，将第四第五章分

别提出的低通信成本 LC-PBFT 共识算法和交易信息快速索引算法应用在系统中。最后对系

统各个模块功能进行截图展示，并对系统进行测试。

第七章 总结与展望。对本文的相关内容进行分析以及全名总结，并对未来的相关工作

给出合理的构想。

3

南京邮电大学专业学位硕士研究生学位论文
第二章 相关技术研究

第二章 相关技术研究

本章主要对基于区块链的奢侈品珠宝交易溯源系统中的一些核心技术以及现有的溯源系 统进行研究。首先简要介绍区块链技术的相关概念，包括共识机制、Merkle 树等，介绍珠宝 交易溯源系统中用到的 IPFS 技术。接着介绍了传统的奢侈品珠宝溯源系统和基于区块链的 其他领域的溯源系统的研究与发展，总结出区块链技术在奢侈品珠宝溯源系统中的必要性和 优势。最后对基于区块链的奢侈品珠宝溯源系统的国内外现状进行分析并提出其存在的缺陷 然后引出本文的解决方案。
2.1 基础知识
基于区块链的珠宝交易溯源系统中是通过区块链为核心技术来确保溯源信息的安全性和 真实性，因此本文需要深入了解区块链的概念、存储结构、基本工作原理和一些核心技术。 本节将对涉及到的区块链相关基础知识进行介绍。
2.1.1 区块链概念
最早出现区块链概念是在 2009 年中本聪发表了一篇名为《比特币：一种点对点的电子 现金系统》[1]的论文中，广义上来说区块链指代着一种将分布式共识、分布式存储、密码学 技术、P2P 网络技术、奖惩机制、智能合约等技术相结合用来实现去中心化的无信任交易的 新型分布式账本技术形式[2-3]。
如图 2.1 所示，区块链体系架构从上到下依次为应用层、合约层、激励层、共识层、网 络层和数据层。其中应用层主要是对区块链应用场景进行封装，例如金融领域等；合约层主 要是对自执行代码脚本和智能合约进行封装，使得账本拥有可编程特性；激励层中主要集合 了发行、分配机制，通过激励机制来鼓励区块链网络中的节点积极参与共识和奖励验证安全 的节点；共识层主要是各类共识算法，例如 PoW、 PBFT 等，用来实现交易打包交易成区块 以及区块上链；网络层是分布式组网方式、传播机制等，用来实现节点之间的通信；最后数 据层中包含了数据区块存储，区块链式存储结构以及加密技术等，用来实现数据存储和保证 数据安全。

4

南京邮电大学专业学位硕士研究生学位论文

可编程货币

可编程金融

应用层
可编程社会

脚本代码

智能合约

合约层
沙盒环境

发行机制

分配机制

激励层

POW

PBFT

DPOS

POS

共识层
……

第二章 相关技术研究

验证机制

P2P网络

时间戳 非对称加密

数据区块 Merkle树

网路层
传播机制
数据层
链式结构 哈希函数

图 2.1 区块链体系架构
狭义上来说区块链还是一个链式存储结构，它由多个区块链接在一起组成，区块链结构 如图 2.2 所示，每个区块中包含区块头和区块体两个部分。区块头中主要存储哈希值以及 Merkle 树根等并且通过前一区块哈希值索引形成链式结构等，区块体中主要是对区块中的交 易数据进行存储。区块通过存储的前一区块 hash 值索引可以向前追溯到交易涉及到的区块， 查询交易信息，而且一旦区块内数据信息被改动，那么该区块的新 hash 值将和存储的 hash 值索引相异，导致无法找到前面区块。这些特性证明区块链技术很适合与溯源领域结合[4]。

前一区块

版本号 前一区块hash

时间戳 难度值 随机数 Merkle树根

区块头 后一区块

Hash1-4

区块体

Hash1-2

节点1 Hash1
交易1

节点2 Hash2
交易2

Hash3-4

节点3 Hash3
交易3

节点4 Hash4
交易4

图 2.2 区块链结构图 5

南京邮电大学专业学位硕士研究生学位论文
2.1.2 Merkle 树

第二章 相关技术研究

Merkle（默克尔）树其实是一种类似树形的 Hash 数据结构[5]。上图 2.2 可以看出，该 Merkle 树有四个叶子交易节点，分别通过对四个叶子节点进行 Hash 运算，然后这些节点哈 希值被不断的两两的运算组合最终获得 Merkle 根哈希值。
使用 Merkle 树存储数据可以保证区块链数据不可篡改。每个数据通过 SHA256 计算出 的哈希值是唯一的，两个不同的数据哈希值通过 SHA256 计算不会得到相同的哈希，所以如 果某个叶子节点上存储的信息被篡改，那么计算出的 Merkle 数根的哈希值也会随之变化， 从而导致区块哈希值随之改变。所有如果意图篡改节点信息数据，需要修改当前区块后面全 部区块存储哈希值，比特币系统中至少拥有 51％的算力才可以篡改成功，而在实际条件下 这种可能性很低。另外因为 Merkle 树是一颗二叉树，所以只需要计算2푙표푔￿￿次就可以遍历全 部叶子节点大大节省了查询时间，提高查找交易节点效率。然后在验证交易内容时，只需要 通过对 Merkle 树根的哈希值进行验证就可以知道是否被篡改，并且可以实现快速定位更改 内容位置[6-7]。

2.1.3 共识算法

共识算法就是将区块链网络中各个未产生信任的节点之间通过某种机制实现数据一致性 的协议。早期的共识算法只对系统节点出现宕机以及网络故障等非人为干预问题进行关注， 而不考虑节点出现人为恶意篡改数据等问题[8]。而目前各个区块链应用中最多使用的共识算 法主要包括 PoW、PoS、DPoS 和 PBFT 等。下面分别对这些共识算法进行简单介绍并进行 分析：
PoW[9]（工作量证明）。2008 年中本聪第一次将 PoW 应用在比特币系统中，PoW 目的是 决定哪个节点可以进行记账。原理就是每个节点通过哈希计算随机数难题来获取记账权，而 最先得出结果的节点可以进行此次生成区块。所以，PoW 的优点是去中心化彻底，必须根 据节点能力来决定记账，缺点是每个节点都要进行大量哈希计算，造成资源浪费，效率较低。
PoS[10]（权益证明）。PoS 相比于 PoW，引入了币龄[11]的概念，获得记账资格不再单单 比拼计算力，而是基于货币数量和持有时长的积。所以，PoS 的优点是减少哈希计算并减少 共识时间，节省资源。缺点是有一点中心化，若越早加入网络同时 拥有多货币数量的节点， 记账权越会容易一直在该节点掌握。
DpoS[12]（委托权益证明）。2014 年 4 月 Dan Larimer 提出了 DPoS[13]，共识过程中有投
6

南京邮电大学专业学位硕士研究生学位论文

第二章 相关技术研究

票环节，被所有节点投票选举出来的代表们代替其完成区块生成。因此，DPoS 优点是记账

节点减少，出块速度快，共识速度快，更加安全，节约资源。缺点是可记账节点变少，牺牲

了部分去中心化。

PBFT[14]（实用拜占庭容错算法）。PBFT 共识算法原理是节点间可以通过签名确认的手

段在共识流程中实现通信，然后在确认阶段获得相应数量的请求信息后，共识完成。所以，

PBFT 优点是共识效率高和吞吐量高，接受容纳恶意节点，缺点是通信复杂，不易扩展，依

赖网络状况。

2.1.4 智能合约链码

智能合约又称为链码，是一种存在于区块链上去中心化的、信息共享的自动化执行代码。 参与者依据合约内容达成协议后以智能合同的形式部署，可以接替参与方自动的执行代码[8]， 可以最大程度地减少交易时需要依赖可信中介以及恶意事件发生[15]。在以太坊生态系统中， 智能合约就是一种拥有合约代码和存储空间以及账户地址的虚拟账户，依据其账户地址可以 得到智能合约，和正常用户账户不一样的是合约账户有自己的空间来存储发生的全部操作。

2.1.5 IPFS 技术介绍

IPFS（星际文件系统）是一种点对点的分布式文件系统，目的是对网络中所有有着相同 文件系统的计算机设备进行连接而设备直接通过分布式网络进行共享传输。IPFS 系统会对 每个文件进行内容哈希运算，得出一个唯一的哈希值，若文件不是完全一样，那么文件的哈 希值就不会重复，所以同一文件在 IPFS 中只会存在一个，这样可以减少资源浪费，减少存 储的成本，并且保证了系统中文件的唯一性。在寻找文件时，系统可以根据文件哈希值来索 引到该文件。IPFS 将 Bittorrent 群集、git 版本控制系统、分布式哈希表结合起来实现具有高 吞吐量以及内容寻址特性的去中心化存储，可以方便用户追溯到文件的版本历史。点对点的 超媒体可以存储各种类型文件，本文中采用该技术可以存储奢侈品珠宝的图片信息等相关大 文件。

2.2 基于区块链的溯源系统研究与发展

本节先对传统的一些奢侈品溯源防伪进行研究并对传统的奢侈品溯源防伪优缺点进行分 析，然后对区块链应用到其他领域溯源进行研究并分析其优缺点，最后说明区块链技术应用
7

南京邮电大学专业学位硕士研究生学位论文
到奢侈品珠宝领域的必要性。

第二章 相关技术研究

2.2.1 传统的奢侈品珠宝溯源研究现状

对奢侈品珠宝进行溯源即包含了对珠宝供应链信息和后续交易信息进行溯源，其中珠宝 供应链包含了从原材料、加工成品、运输货物、经销商等流程环节中记录的信息进行查询以 及辨认珠宝信息的真实。如果任何环节步骤出现问题，用户可以通过珠宝溯源系统进行追溯， 查出该珠宝流程中出错的那一环节，帮助消费者进行后续售后服务，而监管机构也会对珠宝 各环节进行不定期检查，发现问题可以快速截断珠宝，以防让消费者购买到瑕疵品。随着科 技的发展，国内外都出现了相对完善的溯源系统，大多都是针对农产品、食品等需要溯源的 交易品。系统一般都是由生产企业、销售商等行业内组织搭建，如一个区域内的农产品供应 链溯源系统、电商平台溯源系统等，给消费者提供了溯源的渠道以便查询购买的物品信息。
早期奢侈品只在防伪方面进行研究，而且是通过商品标签上的标识以及生产商的数字签 名来进行对奢侈品进行防伪[16]。LV 品牌早期的防伪只能依靠人的感官识别味道、皮质、编 号等做工方面来判断该奢侈品是否为正品，以及有纸质的鉴定证书来保证奢侈品是正品[17], 百达翡丽[18]腕表从表盒的材料和开合设计以及表面的射频技术来判断奢侈品的真假。2005 年中国市场受到假冒商品冲击，导致很多国外的奢侈品品牌从中国市场退出，国内防伪专家 张鹏程提出了一个史无前例的 “内涵防伪”理念，解决了传统的标签防伪等存在的缺陷，增加 制假难度，增强奢侈品防伪可靠度[19]。贵州茅台公司承担的"高价值商品防伪和追溯的 RFID 系统关键技术开发与示范应用"项目根据 RFID 技术与防伪识别，研发出了对高档酒类等奢侈 品产品从产生到售卖各个环节的电子监控与防伪追溯体系，使得酒类可以进行信息追溯[20]。
传统的奢侈品珠宝溯源追溯方案[16-20]有以下几种： （1） 纸质生产证明和防伪证书：这种是较为传统的溯源方式，奢侈品珠宝的生产商通 过把纸质生产证明书和防伪证书分发给销售方，销售方拿到奢侈品后鉴别生产证明和防伪证 书通过后进行销售。这种方式的溯源存在的缺陷就是容易被破解和复制，比如防伪标签扣等 工艺并不复杂，很容易被仿冒厂商伪造，溯源的时候也看不出端倪。 （2） 中心化的珠宝溯源平台：公司开发出溯源软件平台，人为手动将奢侈品珠宝的材 料来源、生产过程、流通过程等环节数据输入到平台中存储来提供给客户完成奢侈品的溯源 追踪和查询。但这种单个企业管理的中心化存储的溯源平台数据完全依赖于输入数据的人， 易被篡改，无法保证数据的可靠性和安全性以及溯源查询出来的信息是真实可靠的。

8

南京邮电大学专业学位硕士研究生学位论文
2.2.2 基于区块链的其他领域溯源研究现状

第二章 相关技术研究

区块链的去中心化、数据不可篡改、透明、可追溯等特性可以有效地解决传统物流和供 应链系统中存在的不可靠信息和数据安全等问题[21]，因此近年来出现了很多相关研究。
在国外，Ongena G[22]提出将区块链技术应用在提高有机或公平贸易食品可追溯性方面。 将有机食品的基本信息传到区块链上，监管部门可以看到有机食品的流通过程，实现有机食 品的可追溯性。Angwei Law[23]提出将区块链技术应用于供应链系统，可以更高效率对供应 链进行管理。Hackius 等人[24]研究了近几年区块链应用在远洋航运过程中等案例[25]，并且阐 述了了区块链技术在这些应用中的关键性；Caro M P 等人[26] 提出了将物联网与区块链技术 相结合应用到食品供应链溯源系统中来解决现有农业食品溯源都是中心化系统管理的不透明 性问题。沃尔玛[27]提出将区块链技术应用到商城的食品溯源体系，并且在中国以猪肉作为实 验对象，实验结果表示定位一批不合格的猪肉产品最多只需要花费 10s；沃尔玛[28]提出物联 网技术与区块链技术相结合应用在控制无人机配送领域，解决了物流中的“最后一公里”难题。 文献[29]中 J F 提出了将区块链技术应用在医学药物溯源领域，将药物的售卖流转记录信息存 储在区块链上，实现医学领域的区块链药品管理系统。另外国外还有一些企业对区块链技术 应用在产品管理上进行了研究[30-31]。
在国内，盛琪等人[32]提出一种结合了区块链技术的供应链数据追溯系统，解决传统存在 的信息不透明性、不安全性等问题。曹杰[33]等人提出了一种基于区块链的防伪平台，将区块 链技术应用在保证合同和文件真实性方面，通过区块链技术实现文件信息验证、合同防伪以 及历史操作记录追溯等，体现出区块链技术特点。丁庆洋[34]等人提出了一种溯源防伪的电商 模型，主要结合物联网技术和区块链技术实现对商品的流转信息状态动态上传，可以对商品 信息更好的进行管理。魏凯[35]等人探讨了将区块链技术应用在知识产权、食药畜牧、数字凭 证、供应链这四个领域进行溯源的可行性。文献[36]提出了结合区块链技术的防伪溯源系统， 通过双链环境以及 IPFS 存储商品信息，确保溯源信息数据的真实可靠。刘耀宗等人[37]提出 了一种将区块链技术和 RFID 以及大数据技术结合的追溯模型，该追溯链具备了透明性、真 实性等。文献[38]提出了结合区块链技术的汽车供给链的溯源系统。系统中将供给链的各个零 件信息、交易信息等存储在区块链上，确保追溯的数据信息安全，从而使消费者对汽车信息 建立信任度。
但是伴随着因客户量的变多和奢侈品溯源信息不断增多导致系统内节点增加，系统中的 共识速度会受到影响，从而导致系统的吞吐量以及查询的速率。因此，国内外学者对系统效 率和共识算法以及查询速度等方面都进行了相关研究。
9

南京邮电大学专业学位硕士研究生学位论文

第二章 相关技术研究

（1） 系统效率方面

文献[39]提出了一种可以操作动态数据存储的双联盟链结构，并设计了一个改进的共识算

法来实现物联网动态安全存储问题，并分析实验证明该方案可以很大程度的解决动态数据可

信度问题，而且系统的执行效率也加快了不少。文献[40]提出一种快速出块策略使得写入速度

随着平台的并发量不断变化，同时还提出了双链存储机制，通过实验测试证明，该方案大大

提高系统的安全性和存储性能速度。

（2） 共识算法方面 在共识效率上，文献[41]中分析了 PBFT 在溯源系统中存在的效率问题，并提出了一种改

CPBFT 的共识算法。减少了协商一致的步骤，并采用投票方式选举主节点。实验测试表明， CPBFT 共识算法减少了网络上的数据传输量，提高了共识效率，提高了吞吐量。文献[42]提

出了 EPBFT 改进共识算法，解决联盟链中 PBFT 存在静态网络结构、通信消耗大等问题。 实验测试表明，EPBFT 算法可以提高系统效率。文献[43]在 PBFT 中结合了 DPOS 中的授权

机制来减少共识的时延。

（3） 查询速度方面 在查询效率上，文献[44]提出了一种可动态变化的区块链存储容量的查询方法，在不同环

境中用不同的查询机制来最大程度的优化数据查询速度，提高系统查询效率。Yadav A S[45]

等人提出一种改进哈希表搜索的查询方法，实验证明查询速度比传统广泛线性搜索提高一倍

以上。文献[46]中提出一中基于双区块链的可验证查询优化方法，保证信息可靠安全的同时还

很大程度加快了查询速度。

2.2.3 小结

由于传统的珠宝溯源系统存在容易被篡改、伪造、以及中心化管理数据信息的不可靠性， 而区块链技术拥有去中心化存储、防篡改机制等优势使得将区块链技术应用在奢侈品珠宝溯 源防伪领域成为必要发展趋势。

2.3 基于区块链的奢侈品珠宝溯源研究与发展

将区块链与奢侈品珠宝溯源的相结合的方面，国内外研究人员都提出了一些解决方案。 文献[47]分析了传统溯源系统存在的缺点，并提出和区块链技术结合，实现基于区块链的溯源 系统。Everledger[30]成立于 2015 年，提出了将区块链技术应用到钻石的防伪溯源领域，在部 署的区块链系统上记录钻石从生成到流转整个过程信息，并且每一个钻石都有一个自己的账
10

南京邮电大学专业学位硕士研究生学位论文

第二章 相关技术研究

本来记录自己的来源流转交易信息。并且，2016 年 Everledger[48]开发并提供给奢侈品钻石珠

宝商一个基于区块链的奢侈品钻石溯源平台，可以让生产商和消费者能够通过验证码就可以

查询到钻石从原产地到生产到流通到消费者手里的整个流转过程的信息；BlockVerify[31]是专

门为药品以及奢侈品提供真伪验证、识别虚假交易的企业，并为其提供基于区块链技术的防

伪溯源系统的企业。VeChain（唯链）是全球第一个提出将区块链技术和 NFC 防伪芯片进行 结合。文献[49]提出了一个基于区块链技术和 NFC 芯片防伪技术，通过智能合约实现信息公

开透明的奢侈品溯源平台。通过将奢侈品芯片唯一标识 ID 以及奢侈品内容放在区块链系统

进行存储管理上，奢侈品品牌方可以通过系统中的智能合约来对奢侈品权限进行管理，这显

然更适用于现代化的奢侈品生产流程。

Biswas K 等人[50]2017 年提出了将区块链技术应用在葡萄酒供应链溯源方面并开发出了

基于区块链的高端葡萄酒供应链溯源系统，该溯源系统将葡萄酒从原材料到生产到流通到售

卖的整个流转过程的信息都保存在区块链上，解决了葡萄酒供应链中存在掺假、掉包等问题，

以便可以通过溯源码实现溯源出可靠的信息。Rui A N [51]等人 2017 年将区块链技术和 IC 卡

芯片相结合应用在宝石安全防伪领域并开发出基于区块链的宝石安全防伪系统。该系统中提

供宝石防伪证书发行和验证真伪的功能，使用密码学技术发行证书同时在区块链系统中以及

IC 芯片中存储证书相关信息，在验证时取出区块链中存储的珠宝证书信息，然后和存储在 IC 芯片里的信息进行对比验证，来识别珠宝真伪。文献[52]提出区块链技术已经奢侈品珠宝 行业的守护者，区块链和奢侈品珠宝溯源已无法分开。文献[53]阐述著名奢侈品平台 SECOO 在奢侈品品牌联合会上提出将联盟链和奢侈品溯源结合的区块链防伪技术。文献[54]提出基于

区块链的珠宝物证结合的追溯模块技术，便于奢侈品珠宝管理、防伪、安全溯源。

2018 年天猫基于阿里云区块链技术解决奢侈品溯源[55]，开发出基于奢侈品的正品溯源

系统，通过将奢侈品原材料信息、生产过程信息、流通过程信息、售卖信息等都写入区块链

存储，使得每个奢侈品都有证明自己身份的唯一区块链 ID，使得奢侈品正品问题得到解决， 实现一键溯源。YongKiLee[56]制定了一个基于区块链的供应链防伪和可追溯性自主分散解决

方案来开发出一个安全的、供应链信息自动记录的验证奢侈品数据完整性的奢侈品数据来源

跟踪和管理平台。

文献[52-55]已经实现了一些将区块链技术应用在奢侈品珠宝的去中心化溯源系统，在该系

统中将奢侈品珠宝的材料来源、生产过程、流通过程等相关方通过监管机构认证后成为联盟

链的注册成员，可以将其作为节点进行管理和控制。系统将奢侈品珠宝的供应链信息、物流

信息和售卖信息等打包成区块存储在链上以便用户进行追溯查询珠宝信息，随后将生成的区

块广播给区块链网络中其他节点，通过共识机制达成同步数据。区块链中的所有节点都维护
11

南京邮电大学专业学位硕士研究生学位论文

第二章 相关技术研究

着同样的账本数据，如果某一个节点想要篡改数据即造假的化，必须要篡改一半以上节点，

因此篡改难度较大，不容易造假数据。因此，通过区块链技术来进行溯源奢侈品珠宝更加合

理可靠。

但是随着交易和奢侈品珠宝的数量越来越多，区块链中的区块不断增加，从而导致在查

询交易信息过程中需要遍历大量的无关区块浪费大量时间，影响到信息结果返回速度。而且

随着系统中企业和消费者用户的增多，区块链系统中需要参加共识的节点数量也会随之增加，

导致在上链一个区块时节点之间完成共识该区块的时间变长，从而影响到系统的吞吐量以及

系统效率。所以需要像其他领域溯源系统一样需要对查询区块信息时进行优化以及对系统节

点间的共识机制进行优化等等。本文将研究区块链 PBFT 共识算法并对其改进，提出了基于

多层分组的低通信成本的 PBFT 共识算法来解决系统节点增到导致的共识时延长和通信成本

多的问题，加快共识效率和降低通信复杂度。并且本文提出一种基于区块链的珠宝交易溯源

系统的快速索引算法来解决重复溯源同一奢侈品珠宝、逐个遍历无用区块和逐个匹配叶子节

点造成的时间浪费问题，加快信息返回速度。这两个方案的具体实施设计过程在第四、五章

进行详细介绍。

2.4 本章小结

本章主要对基于区块链的珠宝交易溯源系统涉及到的一些技术进行研究以及现今溯源系 统的研究现状并提出还存在的问题引出后文的改进方案。首先简要介绍了区块链技术的相关 概念，随后着重阐述了区块链中的共识机制并对其做出分析。其次对传统珠宝溯源系统进行 研究分析以及对一些基于区块链的其他领域溯源系统进行研究分析以及一些在系统效率、查 询优化等方面的改进方案，并且总结出区块链技术在奢侈品珠宝领域溯源系统中的必要性和 优势。最后对国内外研究基于区块链的奢侈品珠宝交易溯源系统进行分析并提出其存在的缺 陷。

12

南京邮电大学专业学位硕士研究生学位论文

第三章 基于区块链的珠宝交易溯源系统总体设计

第三章 基于区块链的珠宝交易溯源系统总体设计

本章主要将区块链技术应用于珠宝交易溯源系统中并对本课题的基于区块链的珠宝交易 溯源系统进行总体设计。首先对基于区块链的珠宝交易业务流程进行分析，并阐述系统的功 能模块需求，同时构建出基于区块链的珠宝交易溯源系统的总体架构图以及网络部署图。然 后分析并设计出系统的各个子功能模块并画出其对应的 UML 时序图，最后对系统的数据库 进行设计并给出关联结构图以及 E-R 图。
3.1 系统需求分析
本节根据基于区块链的珠宝交易整个流程分析出各个环节的主要工作，然后分析出本文 基于区块链的珠宝交易溯源系统的功能需求以及非功能需求。
3.1.1 基于区块链的珠宝交易溯源系统业务流程分析
对奢侈品珠宝进行溯源需要将珠宝在原料商、生产商、经销商、零售商等整个珠宝流转 环节的全部交易信息保存在区块链上，通过区块链技术的不可篡改以及去中心化等特性来确 保珠宝在各个流转环节交易信息上链的真实性和透明性，通过区块链维护的分布式账本的链 式存储结构特性保证了珠宝交易信息的可追溯性。
本小节对珠宝从原料、生产、物流、存储、经销、零售等环节步骤进行详细阐述，设计 出整个基于区块链的珠宝交易溯源系统业务流程方案，奢侈品珠宝溯源各个环节参与方将珠 宝的相关信息进行采集并提交到交易池中，当交易池达到某种条件后把交易信息提交给某个 节点并达成共识后生成区块，链接在区块链的末尾区块后。当区块链网络生成后，监管部门 可以正向跟踪奢侈品珠宝各个环节过程的详细信息，消费者通过系统可以追溯到珠宝从原材 料、生产、运输、存储、销售等整个业务产业链的全部信息。珠宝交易溯源系统业务流程图 如下图 3.1 所示。

13

南京邮电大学专业学位硕士研究生学位论文

第三章 基于区块链的珠宝交易溯源系统总体设计

原料商 生产商
仓储 运输商 经销商 零售商

原料供应商信息 原料品质类型 ……
生产加工商信息 成品珠宝品质类型
……
仓库仓储信息 出库进库信息
……
运输企业信息 物流流转信息
……
经销商信息 批发交易信息
……
零售商信息 交易售卖信息
……

共 识 机 制
交易池

智 能 合 约
智 能 合 约
智 能 合 约
智 能 合 约
智 能 合 约
智 能 合 约
分布式账本

监管部门
正向跟踪各环节

交易 基 信息 于
区

块

链

区

的

块

珠

上

宝

链

交

API 易

溯

源

系

统

查询追溯珠宝
消费者

图 3.1 基于区块链的珠宝溯源系统业务流程图

（1） 原料商环节

原料商环节的主要节点是矿石采集厂、珠宝矿石供应商等。各节点需要调用特定的智能

合约对节点进行身份认证以及原料类型品质等相关信息录入，数据经过处理后在 IPFS 文件

系统中存储，而区块中交易信息保存的是文件在 IPFS 文件系统中的哈希值。当产品从原料

商环节流转到生产商环节时，原料商节点向生产商节点发起交易并将交易放入交易池中，待

交易池满足条件时并在完成密钥验证区块后，调用区块链系统中提前设定的智能合约进行交

易并且将交易信息打包成区块然后广播至区块链网络中其他节点，当系统中节点完成共识后

完成交易并将交易信息区块进行上链，同时将区块中每个原料 ID 和当前区块生成时间戳以

及区块哈希分别进行对应链下存储。

（2） 生产商环节

生产商环节的节点主要是由珠宝加工厂、生产企业等组成。当某珠宝流转到该环节时，

生产商节点会执行设定的智能合约进行身份信息认证以及相关生产数据录入。在录入珠宝质

量合格情况时需要监管部门参与并对其进行数字签名认证一同写入区块。与上面交易环节类

似，在生产商环节向仓储环节交易时，不但需要存储生产商信息还需要生成珠宝唯一 ID 并

且在该环节的每个交易节点中都存储该珠宝原料的所在区块时间戳，同时链下存储珠宝唯一

ID 和区块时间戳以及区块哈希。
14

南京邮电大学专业学位硕士研究生学位论文
（3） 仓储环节

第三章 基于区块链的珠宝交易溯源系统总体设计

此环节的节点主要是由企业仓库或保税仓等组成。在生产商环节后的奢侈品珠宝会先存

入仓库。与之前环节类似，仓库节点也会执行设定的智能合约进行身份信息认证以及仓储等

相关数据录入。同样的，在像运输环节流转时，相当于对经销商发起交易，不仅存入仓储信

息等，还需要存入从链下数据库中存储的交易中珠宝 ID 对应的区块生成时间戳，共识完成

后同步更新链下存储的最新珠宝交易区块时间戳和区块哈希，并完成该环节。监管机构有权

对仓储信息进行审查。

（4） 运输商环节

本环节节点主要是物流企业。在环节在流转到经销商前，需要对珠宝的物流消息进行上

链，相当于物流公司节点对经销商进行交易，同前面一样，运输商节点也会执行设定的智能

合约进行身份信息认证以及相关物流数据录入，并更新链下存储的最新珠宝交易区块时间戳

和区块哈希。

（5） 经销商环节

本环节的主要节点是经营企业等。珠宝流转至经销商环节后，首先会调用设定的智能合

约进行身份认证以及珠宝信息确认，在确认无误后将经营企业经销商信息进行共识上链。珠

宝在从经销商环节向零售商环节流转时，同上面一样，交易进入交易池，交易信息中包含了

经销商信息，批发对象信息等，满足条件后进行共识上链更新操作。

（6） 零售商环节

本环节的主要节点是销售平台、商户等。珠宝流转至零售商环节后，同样的会调用设定

的智能合约进行身份认证以及珠宝信息确认，在确认无误后将销售平台等信息进行共识上链。

（7） 查询环节

本环节主要的节点是消费者以及监管部门。消费者通过应用平台输入珠宝唯一标识 ID

进行珠宝溯源信息查询，系统在后台根据 ID 拿到该珠宝最近区块哈希，通过本文第五章的

快速溯源算法，溯源出所有该珠宝相关交易真实流转信息并返回给用户页面，完成溯源。监

管部门通过查询入口对存在问题的珠宝进行追溯并对相关注册的企业进行法律追究。

3.1.2 功能需求

根据上一节中基于区块链的珠宝交易的流转业务流程分析，本系统将角色划分为管理员、 监管部门、企业机构和消费者四种类型用户，分析每个用户角色所具备的功能并构建 UML 用例图，如图 3.2 所示。
15

南京邮电大学专业学位硕士研究生学位论文

第三章 基于区块链的珠宝交易溯源系统总体设计
流转环节监控

监管部门

操作管理

<<包含>> <<包含>> <<包含>> <<包含>>

珠宝质量检测 查询珠宝信息 恶意操作追究

<<包含>>

查询珠宝信息

<<包含>>

反馈评价信息

<<包含>>
操作管理

账号管理

<<包含>> <<包含>>

登录 注册

管理员

<<包含>>

消费者

角色管理

<<包含>>

操作管理

企业机构

<<包含>> 查看可疑操作珠宝

<<包含>>

查询珠宝信息

操作管理

<<包含>> <<包含>> <<包含>> <<包含>>

珠宝信息录入 发起交易
查看珠宝信息

反馈信息处理

账户管理

<<包含>> <<包含>>

查看成员信息

审核用户信息

图 3.2 基于区块链的珠宝交易溯源系统 UML 用例图
（1） 管理员 管理员在系统中主要负责用户管理、操作管理、账号管理，管理员可以对系统内注册申
请信息进行核查以及分配角色对联盟链参与企业账户管理，同时可以对平台可疑操作进行处 理以及对奢侈品珠宝信息进行查询。 （2） 监管部门
监管部门作为系统中最具公信的政府机构，主要负责审查原料、生产、仓储等流转环节 过程中的信息以及联盟链上其他节点的一些操作信息。当监测到某珠宝质量或者或某企业恶 意操作时，会对问题珠宝追踪召回，情节严重的会对参与的相关企业机构进行处罚追究。 （3） 企业机构
企业机构包括整个流转过程中的全部企业，所有企业都需要经过管理员审核完成身份的
16

南京邮电大学专业学位硕士研究生学位论文

第三章 基于区块链的珠宝交易溯源系统总体设计

认证并进行个人信息上链无法篡改。企业机构具有信息录入、发起交易的功能，不同的企业

机构还有各自不同的功能权限。

（4） 消费者

消费者是系统中最基础的角色。如果消费者只进入系统进行溯源珠宝信息操作，可以不

注册输入查询码即可，但同一商品短时间内最多查询 10 次，因为为了防止恶意操作导致管

理收到大量可疑操作提示。如果消费者需要系统中进行相关其他操作，则需要完成身份信息

注册，才能够进行一系列操作。

3.1.3 非功能需求

（1） 系统高效性。 随着系统中企业机构节点持续的变多已经交易的增加，导致共识的速度变慢，系统吞吐
量和效率会大大下降。所以本文将在第四章给出基于多层分组的低通信成本 PBFT 共识算法 的具体设计。
随着时间的推移，系统的交易数据量呈指数级增长，大量的数据区块导致系统中查询 效率大大降低，会影响到用户体验感。所以本文在第五章给出基于区块链的珠宝交易溯源系 统的快速索引算法。 （2） 安全性。
本文在溯源系统中结合区块链技术已经可以保证链上的数据不被篡改并对用户都进行身 份认证上链，但是链下数据的安全却无法保证。所以本文系统开发时运用 SpringBoot 框架中 集成的 Spring Security 组件，实现对各企业机构以及消费者的身份认证、权限管理等功能。 经过区块链系统成员身份后才可以对区块链中的数据进行上链等操作，保证上链之前的数据 真实可靠。

3.2 总体架构设计

上一小节对系统的业务流程、角色分配以及角色功能进行分析阐述，本小节将给出系 统的系统架构以及功能模块设计。

3.2.1 系统架构

本系统的系统架构图如图 3.3 所示。本系统从上往下分别为应用层、业务逻辑层、数据
17

南京邮电大学专业学位硕士研究生学位论文
存储层、硬件服务器层。

第三章 基于区块链的珠宝交易溯源系统总体设计

基于区块链的珠宝交易溯源系统

账号登录

珠宝溯源

质量检测

发起交易

数据传输

…… 应用层

用户认证

信息录入

重复索引机制 数据同步

节点管理

智能合约

业务
……
逻辑层

Hyperledger Fabric

分布式存储

P2P网络

时间戳

哈希算法

排序服务

链式存储

非对称加密

数据分片 共识机制 数字签名 Merkle树

记录交易

哈希查询

快速定位叶子结点模型 区块距离模型

数据 存储层

节点组网管理

……

阿里云服务器

数据文件服务器

Nginx服务器

Linux服务器

硬件服 务器层

图 3.3 基于区块链的珠宝交易溯源系统总体架构图
（1） 应用层 主要负责显示和用户交互的系统页面，提供账号登录、珠宝溯源请求、交易请求、质检
等用户请求传输到业务逻辑层，同时也会接收底层返回的反馈信息在用户界面上展示。不同 的用户角色展示不同的系统页面，拥有不同的权限进行不同的操作。比如只有监管部门可以 对珠宝流转环节实时监控并参加质量检测，只有监管部门可以进行恶意操作追究。管理员可 以审核用户身份信息和管理企业节点，查看可疑操作珠宝等功能。企业机构可以使用发起交 易和信息录入等功能。消费者可以根据溯源 ID 码发起珠宝信息查询该珠宝全部流转环节上 记录的信息，可以登录系统购买珠宝后通过反馈功能对珠宝进行反馈或者平台的使用反馈。 （2） 业务逻辑层
主要负责接收应用层的数据和请求，包括用户认证、信息录入、智能合约、数据同步、 重复索引机制等业务模块。用户认证业务模块主要是对注册的企业机构节点、用户节点等身 份进行验证授权以防止恶意节点进入整个区块链网络中干扰网络的共识过程。信息录入业务 模块主要包括用户注册身份信息录入和珠宝流转环节交易信息录入。智能合约则是自动化处
18

南京邮电大学专业学位硕士研究生学位论文

第三章 基于区块链的珠宝交易溯源系统总体设计

理应用层传过来的交易或者请求。数据同步业务模块则是一段时间同步给应用层一次最新信

息，以防有最新操作。重复索引机制业务模块主要控制查询缓存以及决定是否继续索引或索

引到哪个区块，并返回相应的数据给应用层展示。

（3） 数据存储层

主要负责存储信息数据和区块。Hyperledger Fabric 区块链平台主要负责将数据存储至区

块链上。收到业务层发来的交易后，将数据存入链下 IPFS 数据库中，同时返回文件唯一索

引 hash，通过共识机制将 hash 分发给区块链网络中的所有节点，在达成共识后将该轮的数

据打包成区块上传到区块链中。真实的大量数据信息被进行文件分片分布在 IPFS 分布式数

据库中，区块中存储的是文件唯一哈希值以及上次交易区块时间戳等数据。

（4） 硬件服务器层

主要负责搭建基于区块链的珠宝溯源系统运行测试的环境。系统代码和分布式数据库放

在阿里云中存储，Linux 系统中运行溯源系统和区块链网络部署。

3.2.2 系统网络部署

根据上一节的系统总体架构设计介绍，本溯源系统的网络部署主要包括上层应用端、区 块链网络、IPFS 分布式数据库。上层应用端中存储着系统前后端逻辑代码并部署在服务器 中，可以给不同用户角色进行各式访问，区块链网络就是整个珠宝流转业务流程上参与的各 类企业机构、监管部门等。系统将交易的数据存储到 IPFS 的分布式数据库中并返回文件唯 一哈希地址标识作为交易数据发送至 fabric 区块链网络中，区块链网络中的节点将交易数据 进行打包成区块在全部节点完成共识后进行区块上链。最终通过应用层的 api 接口对区块链 数据进行溯源并返回展示。系统网络部署如下图 3.4 所示。

19

南京邮电大学专业学位硕士研究生学位论文

第三章 基于区块链的珠宝交易溯源系统总体设计

监管部门 监管部门终端

企业机构 企业机构终端

消费者 个人用户终端

应用端

Internet网络

原料 商企业 服务器 （区块 链节点 ）
仓储 服务器 （区块 链节点 ）

监管部门服务器 （区块链节点）
零售 商企业 服务器 （区块 链节点 ）

生产 商企业 服务器 （区块 链节点 ）

物流 企业服 务器 （区块 链节点 ）

经销 商企业 服务器 （区块 链节点 ）

分布式数据库

图 3.4 基于区块链的珠宝交易溯源系统网络部署图

3.3 系统功能设计

根据系统的功能需求分析，本文为系统的功能设计了以下几个模块，分别是用户注册登 录模块，身份审核模块，数据录入功能模块，信息数据查询模块。 （1） 用户登录模块
用户登录模块功能主要包括了用户注册和用户登录功能。用户注册主要是进入联盟链的 成员节点需要进行身份注册认证，其中包括流转环节上的企业机构节点和参与反馈和购买的 消费者，企业机构填入注册信息时需要提供自己的营业执照以及企业相关信息等。提交注册 信息后经过管理员审核后注册成功。注册认证功能将未参与认证的可能恶意节点排除在区块 链系统外，需要对链上信息进行操作则必须进行身份认证注册。而如果只进入系统进行简单 溯源的消费者不需要注册，只有在需要反馈或者购买时才需要注册身份。 用户登录功能在 输入账户和密码后经安全框架认证后登陆系统进行相关的操作。用户登录的 UML 时序图如 图 3.5 所示。

20

南京邮电大学专业学位硕士研究生学位论文

第三章 基于区块链的珠宝交易溯源系统总体设计

用户

登录页面

服务器

分布式数据库

Security

输入用户相关 信息登录

发送请求
信息错误 登录失败

比对账户信息
返回结果 信息无误身份认证

主页面

成功登录

信息无误

图 3.5 用户登录时序图
（2） 身份审核模块 所有第一次进入联盟链的新成员需要把自己的认证等相关信息存储在区块链中实现身份
不可篡改并且出现恶意操作可以快速定位是什么身份的节点并追究。用户提交申请进入联盟 链的注册信息后，管理员收到申请后通过提前设定好的身份认证智能合约链码对身份信息进 行审核，若审核未通过则返回用户页面重新提交身份认证信息，审核通过后将用户的身份信 息数据放在分布式数据库中保存，并返回文件 hash 地址，然后进行共识上链、存储身份区 块哈希等操作。新节点身份审核 UML 时序图如图 3.6 所示。

用户审核

管理员

IPFS数据

区块链网络

区块链网络

注册身份信息 身份信息有问题

用户信息分布式存 储，返回文件哈希

广播节点开始共识
共识失败，重新选 取主节点

共识成功身份信息 区块上链

审核通过

身份信息区块hash地址存储

图 3.6 新节点身份审核时序图 21

南京邮电大学专业学位硕士研究生学位论文
（3） 数据录入功能模块

第三章 基于区块链的珠宝交易溯源系统总体设计

数据录入模块主要是区块链网络中的企业机构对原料材料信息、交易信息、物流信息等

重要的流转数据录入时所需要的功能模块。节点在登录后对信息进行上传，调用智能合约对

数据进行自动化录入到分布式数据库中并返回文件哈希地址，然后广播给其他节点进行共识，

共识成功后对数据区块进行上链同时更新链下数据库中这些存入信息相关的珠宝的最新区块

地址。数据录入功能模块 UML 时序图如图 3.7 所示。

企业节点登录

智能合约

IPFS数据

共识机制

区块链网络

珠宝相关信息 身份验证失败

存储到分布式 数据库

数据录入成功

文件哈希

共识成功，交易 信息区块上链

共识失败，重 新选取主节点
参与共识

更新珠宝最新交易区块 哈希和时间戳

图 3.7 数据信息录入时序图
（4） 信息数据查询模块 信息数据查询模块主要是给消费者进行珠宝溯源和监管部门跟踪监督整个流转环节。在
输入珠宝溯源码发起查询时，在链上逐步取出该珠宝所有相关的信息，并展示在页面上。如 果只是消费者只是普通查询则不需要登录，但如果短期内恶意查询 10 次以上则会要求登录， 为了防止恶意溯源的发生。信息数据查询模块 UML 时序图如图管理 3.8 所示。

22

南京邮电大学专业学位硕士研究生学位论文

第三章 基于区块链的珠宝交易溯源系统总体设计

查询溯源请求

重复索引机制

IPFS数据

智能合约

区块链账本

输入的珠宝 溯源码

取出部分缓存

连续查询太多防 止恶意操作需登
录系统继续

取出最新交易 区块ID

循环
到达区块取出
交易数据信息

文件哈希至结果集，并 根据区块距离模型跳转 该珠宝上个交易区块

根据哈希集取出真实交易数据返 回给系统用户页面展示

IPFS哈希结果集

图 3.8 信息数据查询时序图
3.4 数据库设计
基于以上的业务流程分析和需求分析，本节将整个流转环节中相应的数据库各个表的结 进行设计，并通过关联结构图保证了信息逻辑关联。数据库关联结构图如下 3.9 所示。

23

南京邮电大学专业学位硕士研究生学位论文
用户id

第三章 基于区块链的珠宝交易溯源系统总体设计

用户id

原料信息表

PK

id

原料名称

int varchar

原料类型

varchar

原料品质

varchar

原料供应商id 原料交易时间戳

int varchar

区块链地址

varchar

原料id

珠宝id

珠宝信息表

PK

id

珠宝名称

int varchar

珠宝溯源码

varchar

珠宝最新区块时间戳 varchar

原料来源

int

珠宝最新区块哈希 varchar

认证时间

varchar

是否交易

varchar

品牌企业 珠宝类型

varchar varchar

用户信息表

PK

id

用户名

用户密码

姓名

手机号

身份证号

区块链地址

用户角色

企业编号

监管部门代号

珠宝id

用户id

int

varchar

varchar varchar

用户id

varchar

varchar

varchar

零售信息表

PK

id

珠宝id

零售商名称

销售地点

销售负责人

经销商id

varchar varchar

珠宝id

varchar

用户id 经销商信息表

PK 珠宝id

id 珠宝id

经销商名称

负责区域

用户id

谈判负责人 备注

int int varchar varchar varchar int
int int varchar varchar varchar varchar

珠宝id

生产信息表

PK

id

生产时间

int datetime

生产负责人编号 varchar

原料来源id

int

原料来源名称 所属检测编号

varchar int

珠宝id

珠宝id

仓储信息表

PK

id

仓库名称

仓库地址

入库来源

入库时间

负责人编号

珠宝id 出库记录

int varchar varchar
int datetime
int int int

物流信息表

PK

id

珠宝id

珠宝id

物流公司名称

物流公司id

出发地名称

目的地名称

珠宝id
int int varchar int varchar varchar

图 3.9 数据库关联结构图
上述数据库的关联结构图是根据珠宝业务流程的各个流转环节记录的数据表连接成表， 主要根据用户 id 或者珠宝 id 连接在一起，根据上述的分析以及数据库关联图可以总结出系 统中的实体有原料、生产、仓储、物流、零售、经销、珠宝、质检、用户，系统的实体 E-R 图如下图 3.10 所示。

24

南京邮电大学专业学位硕士研究生学位论文

第三章 基于区块链的珠宝交易溯源系统总体设计

用户角色

珠宝类型

认证时间

证件号 用户名

监管部门代号

原料名称

原料品质

原料id

最新交易时间 戳

珠宝溯源码

原料类型 原料供应商id

检测时间 检测批次id

质检

检测珠宝类型

原料

区块链地址
1

原料来源

珠宝

处理 交易时间

生产内容

包含

n

珠宝名称

包含
1

检测内容

原料来源id 交易时间

区块链地址 生产

生产负责

包含
1
入库来源

检测结果

检测负责人

生产时间

负责人id

品牌企业

用户密码

企业编号

管理
n

用户

售出
经销商名称 入库时间

经销珠宝id 谈判负责人

经销
1
负责区域

售出

n n
负责
1

手机号

区块链地址
物流公司名称 处理
物流表单id

物流

出发地名称

配送人员

目的地名称

仓储

出库去向 出库时间

售卖负责人

零售

零售商名称

入库负责人id

仓库id

零售珠宝

零售商地址

图 3.10 数据库 E-R 图

3.5 本章小结

本章对基于区块链的珠宝交易系统进行总体设计并给出方案。首先对基于区块链的珠宝 交易溯源系统的业务流程进行分析并给出系统架构图，然后总结出功能需求和非功能需求， 将系统角色用户分为管理员、监管部门、企业机构、消费者。然后根据功能需求将系统功能 划分为用户登录、身份审核、信息录入、信息数据查询等。最后设计系统数据库并给出数据 库关联结构图和 E-R 图。

25

南京邮电大学专业学位硕士研究生学位论文

第四章 基于多层分组的低通信成本 PBFT 共识算法

第四章 基于多层分组的低通信成本 PBFT 共识算法

根据第三章提出的基于区块链的珠宝交易溯源系统，为了提高系统的吞吐量和效率以及 节点可伸缩性，需要对区块链系统的共识算法进行优化。因此，本章提出一种基于多层分组 的低通信成本 PBFT 共识算法(Low Communication-PBFT，LC-PBFT），引入基于节点属性分 组、分层多组共识、末层 raft 共识三种机制的结合降低了系统的通信复杂度和时延以及保证 了系统的安全性，使得系统共识速度更快、吞吐量更大，LC-PBFT 可以达到珠宝交易溯源 的应用要求。
4.1 问题分析
由于本文是针对珠宝溯源的应用场景，完全去中心化不太符合，多个企业合作的联盟链 更适用于本文的溯源系统。而针对联盟链安全要求高的特性，选用当下使用最多的 PBFT 共 识算法。PBFT 共识算法通过三个阶段预准备、准备、提交的过程来确保共识节点最终确认 的消息是一致的，通过传递过程中的签名验证来确保节点能够判断消息是否正确，通过主节 点切换来保证系统不会因为主节点宕机系统也会持续等待的不工作情况。随着珠宝流转环节 中企业节点的不断加入，导致系统出现通信复杂等共识效率低下问题。传统的 PBFT 共识算 法对通信要求很高，假设有 n 个共识节点，那么它需要O(푛￿)节点间通信才可以达成共识， 因此，在 n 越来越大情况下，通信复杂度指数增加，使得共识算法效率低，吞吐量小，系统 效率会大大降低。所以目前联盟区块链的共识算法不能满足实际应用要求。因此，对联盟区 块链共识算法的改进是当前研究的热点之一。
文章[57]提出了一种基于备选投票机制的低延迟共识算法，改进了主节点的选择方法，降 低了农业追溯系统的网络通信开销，节约了传输能量消耗。文章[58]提出了一种改进的 PBFT 算法，引入了评分机制来选择主节点，减少了事务延迟和通信开销。文章[59]研究了一种改进 的 PBFT 节点划分算法，在 PBFT 算法中引入分区和信用机制，达到减少节点恶意行为，维 护系统安全的目的。文献[60]提出一种基于加权平均信息增益的优化 PBFT 共识算法，解决通 信开销大、一致性效率低、领导者节点随机选择等问题，引入加权平均信息增益来减少条件 之间属性的相互影响，提高分类精度，并且选择信任度高的节点形成核心共识小组以及引入 投票机制来决策领导节点。实验结果表明，改进后的 PBFT 算法缓解节点数增加、流量过大 的问题，降低了领导者节点作恶的概率，提高了共识效率。文献[61]提出一种随机分组的混合
26

南京邮电大学专业学位硕士研究生学位论文

第四章 基于多层分组的低通信成本 PBFT 共识算法

共识算法，先进行随机分组，每个组内使用 chain-raft 共识算法进行共识，在组间使用 PBFT

共识算法完成共识。虽然上述文章提出了性能良好的算法，但由于本文珠宝流转环节较为复

杂，企业节点数量众多分布较广，上述算法并不适用于珠宝交易信息的溯源。

基于以上分析，针对现有联盟区块链共识算法应用在珠宝交易溯源这种流转环节较多的

大规模区块链网络情景下时，上述改进的 PBFT 共识算法已然无法满足的低通信复杂度、可

扩展性、低时延、高吞吐量等需求，所以本文提出一种基于多层分组的低通信成本 PBFT 共

识算法 LC-PBFT，提高系统共识效率，减少通信复杂度，保证系统的高效运行。

4.2 基于多层分组的低通信成本 PBFT 共识算法

4.2.1 LC-PBFT 共识算法总体设计
本文针对基于区块链的珠宝交易溯源系统中 PBFT 共识算法的缺陷，提出一种基于多层 分组的低通信成本 PBFT 共识算法 LC-PBFT。该算法分为三部分，首先在准备阶段时 LCPBFT 共识算法先对节点分类进行预处理，基于珠宝流转环节中的企业节点身份的思想对联 盟链网络中的节点进行分组并分 N 层，同时引入监管节点。其次在共识阶段时 LC-PBFT 算 法通过递归地方式在 N-1 层之上的每层节点提交和应答阶段插入 PBFT 共识算法作为子层算 法，提高了可扩展性，而上层形成一个证书来证明达成了共识，根据这个证书，第一层的节 点在第二层子节点之间启动 PBFT 共识过程。然后将第 N 层中的节点采用 Raft 共识算法组 成一个委员会，而委员会中的 Leader 在 N-1 层其他节点代表进行 PBFT 共识， Leader 的出 现减少了最后一层节点的共识时延，加快共识速度。同时分组过程中分配的监管节点可以抵 抗恶意的拜占庭节点，负责监管 Leader，它不参加 Leader 的选举，只参加组内 Raft 共识， 解决最后一层 Raft 组内节点的安全性问题。最后达成全局共识并生成新的块同时更新到联 盟链网络中所有节点。本章按照图 4.1 所示的流程对 LC-PBFT 共识算法进行设计。

27

南京邮电大学专业学位硕士研究生学位论文

第四章 基于多层分组的低通信成本 PBFT 共识算法

LC-PBFT共识算法设计

基于节点属性分组

多层多组递归共识

末层使用Raft共识

引入监督节点

上层Commit插入下层 Pre-prepare

选取Leader代表组内

抵抗Raft中恶意节点

减少通信复杂度

图 4.1 LC-PBFT 共识算法设计流程图

减少共识时延

4.2.2 LC-PBFT 共识算法详细设计

（1） 基于节点属性的分组分层模型 由于整个珠宝交易流转环节过程中涉及很多类型的企业、工厂、监管部门等，它们之间
构建了一个多节点的联盟区块链网络。通过节点所处环节的身份鉴定方法，将全部的可访问 节点按照节点属性进行分组，每个节点都有一个特定的组。节点可以是放在下层的处理和保 存局部事务的普通节点，也可以成为放在上层某组内负责处理事务共识的组长。而整个环节 中相应的权威可信监管部门被选为负责监督组长的管理节点放在最后一层中负责监管 raft 共 识过程中的组长。基于节点属性的分组分层模型见下图 4.2。

28

南京邮电大学专业学位硕士研究生学位论文

第四章 基于多层分组的低通信成本 PBFT 共识算法

第一层
P

m

A11 B12 C13 D14 E15 F16

原料

生产

仓储

物流

经销

零销

……

A21 A23 A22 A24

D21 D23
D24 D22
n

F23 F22 第二层 ……
F24 F21

A31 G1 A32 A34

D31 D32 G2 D33 D34 D35

第三层
G3 F31
……
F32 F35 F34

Bn1 …… Bnn G4

……

Cn1 …… Cnn G5

En1 …… Enn G6

……
Gm

第n层

图 4.2 LC-PBFT 共识算法的基于节点属性的分组分层模型
在上图 4.2 中，浅灰色是该组末层当选的 Leader 节点，深灰色 Gi 为监管节点。例如， 节点 A22 为 A31-A34 的 Leader，节点 G1 为监管节点，负责监管 A22，防止成为恶意节点。
监管节点 Gi 的存在极大地提高了末层 raft 的安全性。监督节点的加入使 Raft 具有抵御 恶意拜占庭节点的能力。因为一旦 Leader 作恶并向该团队下层的子组中的追随者故意发送 恶意消息，那么这会破坏共识的一致性原则。如上图 4.2 所示，每个组的末层至少拥有一个 监管节点，整个流转环节由多个监管节点维护。监管节点主要负责对该子组内的 Leader 进 行监督，所以监管节点不参与 Leader 的选举，只是作为 Follower 参与该子组的共识过程。
LC-PBFT 共识算法在末层 Raft 共识中增加了签名验证，当 N-1 层中的 Leader 向所有的 N 层的子组 Follower 发送日志同步消息时，需要在对消息进行签名并且打包公钥后发布。监 管节点在收到不同子组中 Leader 的日志消息后，需要对消息日志中的签名进行验证同时比 较签名内容来判断本子组 Leader 是否为拜占庭式恶意节点。
29

南京邮电大学专业学位硕士研究生学位论文
（2） LC-PBFT 共识算法流程

第四章 基于多层分组的低通信成本 PBFT 共识算法

步骤 1：在准备阶段，LC-PBFT 共识算法先根据基于节点属性的分层分组模型将联盟链

网络节点进行预处理分组。

步骤 1.1：首先确定所有珠宝交易流转环节的名称等各属性，对所有的可访问节点进行

分类，如果可访问节点是监管部门，则将其选为监管节点，否则选为普通节点。

步骤 1.2：根据节点属性将可访问节点分成相应的组。

步骤 1.3：最后将各小组内进行分层处理，并且前 N-2 层选出上层负责下层子组的共识

的主节点，然后验证全局共识和各小组末层满足共识的基本条件，即第一层节点数大于 3，

每个组的末层子组有效节点数大于 2，且至少有 1 个监督节点。

步骤 2：在共识阶段，在各组验证通过后，每组内末层采用 Raft 共识算法组成委员会并

选取 Leader，而 Leader 随上层节点一起完成子组 PBFT 共识并选出主节点。

步骤 2.1：进入区块链网络第一层，主节点和 m 个第一层的全部节点形成一个共识组，

当主节点 P 收到客户端 C 发送的请求消息M = [표, 푡, 푐]￿￿￿￿￿￿￿时，首先对客户端请求和身份进 行认证并且 P 给该请求消息푀一个序号α。

步骤 2.2：接着主节点通过广播消息[푀, 푑, 훼, 푣]￿￿￿￿￿￿￿￿￿￿￿￿进入푝푟푒 − 푝푟푒푝푎푟푒阶段，其 中푑是푀的摘要（上标是用来区分第一层中的푝푟푒 − 푝푟푒푝푎푟푒￿和第二层中的푝푟푒 − 푝푟푒푝푎푟푒￿）。 主节点 P 只在第一层的节点之间广播消息。因此，只有第一层的节点对푝푟푒 − 푝푟푒푝푎푟푒￿作出 回应。对于푝푟푒 − 푝푟푒푝푎푟푒, 푝푟푒푝푎푟푒和푐표푚푚푖푡阶段的消息，第一层的节点只接受与视图푣相 同的消息。
步骤 2.3：第一层每个节点收到主节点的消息后，也对第一层的其他节点进行通信消息 [푑, 훼, 푖, 푣]￿￿￿￿￿￿￿￿￿￿￿￿ ， 该 消 息 将 푝푟푒 − 푝푟푒푝푎푟푒￿ 和 푝푟푒푝푎푟푒￿ 阶 段 的 消 息 写 入 日 志 。 在
푝푟푒푝푎푟푒阶段，第一层的每个节点会收到2푓个序列号为α、视图为푣、请求为푀的消息，在收 到푝푟푒 − 푝푟푒푝푎푟푒￿阶段的消息后形成一个푝푟푒푝푎푟푒푑 − 푐푒푟푡푖푓푖푐푎푡푒￿证书表明第一层的节点已 经准备好请求，然后第一层节点广播[푑, 훼, 푖, 푣]￿￿￿￿￿￿￿并等待超过2푓 + 1个来自不同第一层节 点的相同视图、序列和摘要的푐표푚푚푖푡￿消息。
步骤 2.4：接收到的消息形成푐표푚푚푖푡 − 푐푒푟푡푖푓푖푐푎푡푒￿(푐푐￿)同时该请求被当作在第一层节 点提交，然后节点暂停执行并在第二层开始另一轮共识，执行步骤三；而已经提交的节点发

送[표, 푡, 푖, 푟, 푣]￿￿￿￿￿￿给该共识组主节点。 步骤 2.5：该共识组主节点通过检查包括它自己的超过一半的组成员回复相同的푟푒푝푙푦￿

30

南京邮电大学专业学位硕士研究生学位论文

第四章 基于多层分组的低通信成本 PBFT 共识算法

消 息 来 确 认 这 个 共 识 组 已 经 达 成 一 致 ， 组 长 把 收 到 的 푟푒푝푙푦￿ 合 成 一 个 푝푟푒푝푎푟푒푑 −

푐푒푟푡푖푓푖푐푎푡푒￿(푟푐￿)。

步骤 2.6：最后第一层主节点发送[표, 푡, 푐, 푖, 푟, 푟푐￿, 푣, 퐺푃]￿￿￿￿￿￿￿￿￿￿。

步骤 3：第一层已经提交的节点会给同一组下的第二层节点发起新的 PBFT 共识请求。

步骤 3.1：当再次提交请求时，所有该组第二层成员按照下列算法 1 中类似的方式进行

共识并回复给第一层中的该子组组长返回给客户端，一直递归执行至节点倒数第二层。

步骤 3.2：然后第 N 层的每个在 N-1 层的组长开始 Raft 的共识，即最后子组内部的共识。

步骤 3.3：N-1 层的 leader 在小组内有效地广播整个事务，小组的成员直接达成一致意见

返回 leader 提交给客户端，完成全网络共识。

LC-PBFT 共识算法执行流程如下 4.3 所示。LC-PBFT 共识算法步骤流程如下 4.4 所示。

C

Request Pre-prepare1 Prepare1 Commit1

P N11 N12 N13

Reply1

Post-reply

Pre-prepare2 Prepare2 Commit2

Group22

N21

Group23
N22

N23

Post-reply Reply2

NLn-1 1
…… NLn-1 2
Group n 1 Group n 2

Uncommited

Commited Post-reply

Group11

Group21

Layern-1 --- Layern

图 4.3 LC-PBFT 共识算法执行流程图

上图 4.3 中，C 代表的是客户端；P 代表的是第一层主节点；Groupi j 代表的是第 i 层第 j

组；Ni j 代表的是该组第 i 层第 j 个节点；NLn-1 j 代表的是 n-1 层中 n 层小组选出的 Leader；

Layeri 代表的是第几层。

31

南京邮电大学专业学位硕士研究生学位论文

第四章 基于多层分组的低通信成本 PBFT 共识算法

准备阶段
根据节点属性 将联盟链网络节点分成各自
角色，选出监管节点
分层分组模型将联盟链 网络节点进行分组分层
No

Request
客户端

共识阶段 主节点

分别进行上层PBFT共识
No
是否到达N-1层

判断小组是否 符合条件
Yes
选出N层raft共识小组中 的leader，放在N-1层中

Yes
最后一层raft共识
全局共识

生成区块

图 4.4 LC-PBFT 共识算法步骤流程图

上层节点 PBFT 共识伪代码如下算法 1。 算法 1：LC-PBFT 上层 PBFT 共识伪代码

Input : 푟푒푞푢푒푠푡￿表示第一层的请求, 푟￿表示第 i 层的节点 Output : 푝표푠푡 − 푟푒푝푙푦￿

1、 初始化第一层 i=0;是否到最后一层 ischildren=True;

2、 while 푟푒푞푢푒푠푡￿.valid = True do

3、

if client.identity =True then

4、

while ischildren =True do

5、

n → m;

6、

send 푝푟푒 − 푝푟푒푝푎푟푒￿ → 푟￿；

7、

number=0;

8、

while 푝푟푒푝푎푟푒￿.valid = True do

9、

number=number+1;

10、 11、 12、

if number >2푓 then forms 푝푟푒푝푎푟푒푑 − 푐푒푟푡푖푓푖푐푎푡푒￿; send 푐표푚푚푖푡￿ → 푟￿；

13、

end

32

南京邮电大学专业学位硕士研究生学位论文

14、

end while

第四章 基于多层分组的低通信成本 PBFT 共识算法

15、 16、

count=0 while 푟푒푝푙푦￿.valid = True do

17、

count=count+1;

18、 19、 20、

if count > this.members.number / 2 then forms 푟푒푝푙푦 − 푐푒푟푡푖푓푖푐푎푡푒￿; return 푐표푚푚푖푡￿ → 푟￿；

21、

end

22、

end while

23、 24、

sum=0 while 푐표푚푚푖푡￿.valid = True do

25、

sum=sum+1;

26、 27、 28、

if number >2푓 then forms 푐표푚푚푖푡 − 푐푒푟푡푖푓푖푐푎푡푒￿; send 푝표푠푡 − 푟푒푝푙푦￿ → client；

29、 30、

end if 푟￿.children.number < 0 then

31、

isChildren=false;

32、

End

33、

end while

34、

i=i+1;

35、

end while

36、

end

37、 end while

4.2.3 LC-PBFT 共识算法分析
1、相比于传统的 PBFT 共识算法，LC-PBFT 对联盟链网络节点进行分层分组大大减少 了节点间通信复杂度，减少通信成本和复杂度，在处理全局事务时，共识的前 N-1 层具有拜 占庭式的容错能力，确保事务能够传递到所有节点，信息传递公开透明。
2、相比于已有的双层 PBFT 共识算法，多层的通信复杂及成本更低，下面的实验会进 行分析，并且 LC-PBFT 共识算法在第 N 层共识过程中采用的 raft 共识算法具有较高的共识 效率，同时引入具有抵御恶意拜占庭节点的能力的监管节点，解决了传统 raft 无法容忍恶意
33

南京邮电大学专业学位硕士研究生学位论文

第四章 基于多层分组的低通信成本 PBFT 共识算法

节点问题，实现了请求信息的快速传播和扩散。

因此，LC-PBFT 算法不仅实现了低通信成本，而且还实现了共识算法的低时延、高效

率性和一致性。

4.3 LC-PBFT 共识算法实验分析

本节将从通信复杂度、共识时延、吞吐量、安全性四个方面对本文提出的 LC-PBFT 共 识算法、IPBFT [57]共识算法、GBFT[62]共识算法和传统 PBFT 共识算法进行实验对比及分析，

实验结果表明，本章提出的 LC-PBFT 共识算法效率最高。本章实验配置 Intel Core i7 的处理

器、Ubuntu16.04.6 的操作系统、release-2.2 的 Hyperledger Fabric 底层区块链系统，节点部署

在 Docker 容器环境中，使用 Dockerfile 产生容器镜像，Docker-compose 启动联盟节点。

（1） 通信复杂度分析及实验

节点之间的通信成本少意味着系统的通信复杂度低，而通信复杂度是指区块链网络节点

之间的通信次数的多少。通信次数越少，通信成本就越低，通信复杂度就越低，那么系统的

可扩展性就越好。

本文假设珠宝交易溯源系统联盟链中总节点数为푁,那么传统 PBFT 的共识通信成本为

O(푁￿)，而本文的 LC-PBFT 共识算法假设将节点分成 L 层节点网络，每层节点数为푛￿，푁和

푛￿的等式见公式 4.1，而 LC-PBFT 共识算法的通信成本见公式 4.2；
￿￿

푁￿ = ￿(￿ 푛￿) + 1
￿￿￿ ￿￿￿ ￿￿￿
퐶￿ = ￿ 푛￿￿￿푛￿￿￿(푛￿￿￿)￿ + 푛￿ ∗ 3
￿￿￿

(4.1) (4.2)

那么根据 4.1 和 4.2，假设每个子组分配 3 个节点。可以推出其最小通信成本为公式 4.4—4.6

推导，其中퐿￿￿￿ 为最大层数，푁为总节点数；

퐿￿￿￿ = log￿(2푁 + 1) − 1

(4.3)

￿￿￿￿￿￿

퐶￿ = ￿ 3￿￿￿(3 + 1)￿ + 3￿￿￿￿(￿￿￿￿)

(4.4)

￿￿￿

=

16

∗

1

−

3￿￿￿￿(￿￿￿￿)￿￿ 1−3

+

3￿￿￿￿(￿￿￿￿)

34푁 − 34 =9

(4.5) (4.6)

从上面公式推导可以看出在分层的深度尽量大时，网络节点通信成本复杂度为￿￿￿￿￿￿，随着
￿

34

南京邮电大学专业学位硕士研究生学位论文

第四章 基于多层分组的低通信成本 PBFT 共识算法

节点总数线性增长相比于传统的 PBFT 的指数性增长来说，LC-PBFT 通信复杂度更低，有更

好的可扩展性。本文将节点总数从 20 开始向上逐渐递增，比较节点之间的通信复杂度，实

验结果如下：

图 4.5 通信复杂度随节点总数递增变化
从图 4.5 中不难发现，在同样的网络情况下，随着节点总数的递增，几种共识算法的通 信复杂度都随之提升，这是由于节点增加那么每个节点所需要通信的邻节点就会增多从而增 加通信复杂度。其中传统的 PBFT 是的通信复杂度呈指数型增长，因为其单层的限制每增加 一个节点，就要多进行当前节点数量次数的通信，IPBFT 是改进了传统 PBFT 减少了参加共 识的节点数量，他比传统的 PBFT 通信复杂度要少，而双层 GPBFT 共识算法会比单层的 PBFT 共识算法通信复杂度都要小，因为其将节点分成两份分别进行共识会大大减少通信复 杂度，但随着节点的越来越多，它的复杂度在达到某个界限时会超过本文提出的多层 LCPBFT 共识算法。本文提出的 LC-PBFT 共识算法是线性增加的，并且从图中可以看出在节点 总数少于 40 时，双层的 GBFT 比本文的共识算法通信复杂度方面要低，这说明在节点数量 超过 40 时对系统进行多分层共识可以很好降低通信复杂度，更适用于本文流转环节多的珠 宝溯源即联盟链中节点比较多的场景。 （2） 共识时延实验
共识算法的时延是指从客户端发起请求到确认请求的时间。时间越少说明达成共识速度
35

南京邮电大学专业学位硕士研究生学位论文

第四章 基于多层分组的低通信成本 PBFT 共识算法

越快，区块链系统效率越高，公式如下，下面从两个方面对共识时延进行实验。

푇퐷 = 푇￿￿￿￿￿ − 푇￿￿￿

(4.7)

其中푇퐷表示共识时延，푇￿￿￿￿￿代表客户端发起时间，푇￿￿￿代表确认请求时间。

实验 1：设定节点数从 20 开始逐渐增加，交易数为 100，取 20 次测量值取平均值，实

验结果如下：

图 4.6 共识时延随节点总数递增变化对比
由图 4.6 可知，共识时延大小会随着系统内节点数的增加而增大。其中传统 PBFT 共识 算法增长速度最快，LC-PBFT 算法增长最慢。但是在节点数 60 以内时，由于多层的缘故对 共识流程有一定影响导致本文提出的 LC-PBFT 相比单层或者双层 PBFT 共识算法来说，共 识时延反而会大一点，而在节点数量越来越多时，本文的共识算法的优势就体现出来，在相 同的节点数量下，LC-PBFT 的时延远远要比传统 PBFT 要小。由于本文的珠宝溯源场景中流 转环节过多，导致节点数量远远超过界限，因此，LC-PBFT 共识算法更适用于本文珠宝交 易溯源领域中，LC-PBFT 可以保证较高的共识效率。
实验 2：设定参加共识的节点数量为 100，测试系统在每个区块打包的间隔时间不变的 情况下发送 1000 条交易的时延，进行 20 次测试进行统计，实验结果如下：
36

南京邮电大学专业学位硕士研究生学位论文

第四章 基于多层分组的低通信成本 PBFT 共识算法

图 4.7 1000 条交易量下共识时延对比

从图 4.7 可以看出，在节点数量都为 100、出块间隔和交易量一致情况下，记录 20 次实

验的共识时延，其中传统的 PBFT 共识时延最大，单层 IPBFT 和双层 GBFT 共识算法比传统

的单层 PBFT 算法时延要小，但是比本文提出的 LC-PBFT 要大。因为在节点数量达到 100

的情况下，虽然 LC-PBFT 进行了多层共识影响一点共识速度，但是在末层增加了 raft 共识

机制的缘故，使得在联盟链中节点数量过多的情况下，LC-PBFT 共识算法可以比其他算法

更高效，所以相对于其他节点较少的情况来说，在本文的流转环节多即节点多的珠宝交易溯

源情境下，LC-PBFT 共识算法效率更好。

（3） 吞吐量性能实验

系统的吞吐量定义为系统每秒处理的交易数量。在区块链系统中，吞吐量表示系统每秒

处理的交易数(transaction per second, TPS)，即总交易数푇푟푎푛푠푎푐푡푖표푛￿￿￿与对应交易完成时间

t 的比值，公式如下:

Tps

=

푇푟푎푛푠푎푐푡푖표푛￿￿￿ 푡

(4.8)

因为系统吞吐量和交易数量和节点总数都有关系，所以下面进行两个实验对 4 个算法的

吞吐量进行测试。

37

南京邮电大学专业学位硕士研究生学位论文

第四章 基于多层分组的低通信成本 PBFT 共识算法

实验 1：设定固定交易量为 1000 条，在每个区块打包间隔不变的情况下，随着联盟链

中节点数量的增加，记录系统稳定时 10 组数据并取其平均值作为测试的 TPS，实验结果如

下：

图 4.8 吞吐量随节点总数递增变化对比
由图 4.8 可知，由于节点增加会使得通信复杂度变高，使得系统吞吐量随着节点数量的 增加而减少。但是，在相同的节点规模下，本文 LC-PBFT 的 TPS 仍然大于 PBFT 和 GBFT， 这是因为 LC-PBFT 的多层网络节点结构和末层 raft 共识算法的设计，使得出块的速度大大 增加。随着系统内的节点规模的扩大，事务量也随之增加，导致资源消耗急剧增加。在一定 程度上，由于通信带宽上限的影响，吞吐量会逐渐减少。因此，在节点规模扩大的同时， LC-PBFT 仍然可以保证较高的吞吐量，运用在珠宝交易溯源领域中的效率更高。
实验 2：设定节点总数为 100，在每个区块打包间隔不变的情况下，随着交易量的增加， 记录系统稳定时 10 组数据并取其平均值作为测试的 TPS，实验结果如下：
38

南京邮电大学专业学位硕士研究生学位论文

第四章 基于多层分组的低通信成本 PBFT 共识算法

图 4.9 吞吐量随交易量递增的变化对比

从图 4.9 可以看出，在节点数量都为 100 的情况下，交易量少于 1500 时，吞吐量随着交

易量的增多而增加，相反的是在大于 1500 时，吞吐量随着交易量的增多而减少，因为在交

易数量达到 1500 时，节点处理不过来交易信息，会导致系统缓慢和堵塞。但整体来说，本

文的 LC-PBFT 的吞吐量最多，更适合本文的交易过多节点过多的珠宝溯源系统。

（4） 安全性分析

联盟区块链在添加节点时具有节点接纳机制，大大提高了共识过程的安全性。LC-PBFT

算法是上层 PBFT 共识和末层 Raft 共识的基础上实现的。它的容错性、有效性、结果一致性

和安全性继承了 PBFT 和 Raft 原有的优良特性。根据节点属性分组和引入监管节点提高了系

统的安全性。LC-PBFT 的最大容纳恶意节点数公式如下：

푓￿

=

푚￿ 3

∗

∏￿￿￿￿￿￿ 푚￿ 2

其中，푓￿为最大容纳恶意节点数，푚￿为 k 层小组数。

(4.9)

LC-PBFT 的上层共识阶段是根据 PBFT 的特性来确保安全性，即 pre-prepare、prepare 和

commit 三阶段的消息需要在同一个 view 中完成，且消耗的时间必须要比节点触发视图切换

所需时间要少，全部消息都符合 PBFT 共识协议的摘要、序列号和签名验证。LC-PBFT 末层

raft 共识阶段的安全性由分配的监管节点来保证，监管节点使得子组内共识具有抵御恶意拜

39

南京邮电大学专业学位硕士研究生学位论文

第四章 基于多层分组的低通信成本 PBFT 共识算法

占庭行为的能力，增强了 LC-PBFT 末层 raft 共识的安全性，普通节点只有在收到来自 N-1

层 leader 的提交消息并验证消息结果为真时，才会将日志信息提交到链上中。如果为

false(监管节点发现 leader 为作恶节点，leader 的身份被驳回)，则需要等待下一个视图同步新

leader 的日志，以防止恶意信息在链上。

4.4 本章小结

本章首先分析了针对现有联盟区块链共识算法应用在珠宝交易溯源这种流转环节较多的 大规模区块链网络情景下时，传统的 PBFT 共识算法无法满足的低通信复杂度、可扩展性、 低时延、高吞吐量和安全性的需求问题。针对这些不足，提出了一种低通信成本的共识算法 LC-PBFT 并进行总体设计。然后分别从基于节点属性分层分组模型、多层共识流程方面对 LC-PBFT 共识算法进行详细设计并给出共识流程步骤和流程图以及上层共识的伪代码，然 后分析该共识算法的优势。最后，从通信复杂度、时延、吞吐量、安全性几个方面对传统的 PBFT 共识算法、改进的 PBFT 共识算法、双层 PBFT 共识算法以及本文的多层 LC-PBFT 共 识算法进行对比实验分析，证明了 LC-PBFT 可以达到本文珠宝交易溯源的场景要求。

40

南京邮电大学专业学位硕士研究生学位论文

第五章 基于区块链的珠宝交易溯源系统快速索引算法

第五章 基于区块链的珠宝交易溯源系统快速索引算法

在第四章对信息上链共识方面完成优化后，当用户进行溯源查询时，为了满足珠宝交易 场景下的信息查询获取的高效性要求，需要对区块链溯源过程效率进行优化。在区块链中， 如果存在交易数据大量增长使得数据区块和区块内信息节点不断增多、重复溯源同一珠宝等 操作，系统的查询速度会变慢，影响用户体验。因此，本章针对区块链溯源系统中珠宝交易 信息查询效率较低等问题，提出一种基于区块链的珠宝交易溯源系统的快速索引算法，引入 了重复索引机制、快速定位叶子节点模型以及区块距离模型，三种机制的配合解决了在溯源 过程中遍历无用区块、逐个匹配叶子节点以及重复溯源某珠宝的时间浪费问题，使得系统溯 源速度更快，优化用户体验。实验证明，该快速索引算法可以达到奢侈品珠宝溯源的应用要 求。
5.1 问题分析
在珠宝交易溯源系统中运用区块链技术进行珠宝供应链信息和交易信息的存储虽然可以 很大程度的减少珠宝交易溯源系统中存在的安全问题，但是还存在部分需要优化的问题。区 块链是一种链式存储结构，数据是按照交易的时间先后对交易信息数据进行打包的形式存储 在链上，区块与区块之间则是通过对前一个区块哈希值的引用进行前后相连。区块头中存储 着上次个区块的 hash 值以便索引查询。首先，当在溯源某个具体奢侈品珠宝信息时，需要 从后面区块向前逐个遍历节点中的所有区块，当短期时间内对同一个奢侈品珠宝进行多次溯 源的时候，会做一些不必要的重复性索引操作，从而影响系统效率。其次，传统的区块链溯 源系统只有从出厂到经销商的商品信息上链，并未涉及到多次不连续交易的信息多次上链的 情况，而在该奢侈品珠宝多次后续交易场景下，溯源时需要从后向前一个一个区块进行查找 上次交易所在区块，并无法直接实现快速定位上个交易区块，这会浪费大量进入无关区块所 消耗的时间。最后，因为一个区块体中的信息是由很多个奢侈品珠宝的交易信息组成，当进 入指定区块中查找匹配的特定奢侈品珠宝的交易信息时则需要逐个比对区块体中 merkle 树 叶子节点交易信息，导致查询效率低，消耗时间过多，使得溯源速度过慢，从而导致区块链 的技术优势被减弱。
在区块链查询优化领域，国内外的研究人员也进行了相关研究。郑浩瀚[63]等人提出了一 种基于改进 Merkle 的 MHerkle 树索引结构的查询方案，实验测试表明该查询方法缩短了区
41

南京邮电大学专业学位硕士研究生学位论文

第五章 基于区块链的珠宝交易溯源系统快速索引算法

块链的查询时间，提高效率，但是因为 MHerkle 索引结构中叶子节点间构建了 B 树结构，

所以在构建索引时计算叶子结点哈希值时消耗了相对较多时间，照成了浪费。李楠[64]提出一

种基于结合了 B+树的改进 Merkle 树结构的查询优化方法，可以快速查找特定记录，并且把

相关数据放到 MySQL 中进行存储方便进行关系查询。实验结果表明，基于 M-B+树的查询

方案可以提高查询速度和多查询条件，但同样的引入 B+树结构，在构建时消耗了很多的时 间。在内置数据结构方面，LineageChain[65]提出 DASL 对数据之间建立索引，可以在写好的

智能合约中提前指定号数据之间的联系，在查询溯源时通过拓扑排序进行查询。在区块链系

统的数据导入到链下数据库方面，EtherQL[66]等人提出区块链中数据导入链下数据库中存储

并依靠数据库来执行数据查询操作，提出依靠以太坊平台的接口实现将区块中奢侈品数据导

入到链下数据库 MongoDB[67]中，然后通过 MongoDB 实现区块数据查询。在区块链同步数

据库操作方面。

基于上面的分析，本章将针对现有溯源系统中多数只是单区块查找、顺序遍历等问题提

出了一种基于区块链的快速索引算法，提高系统的索引效率，保证用户体验。

5.2 基于区块链的珠宝交易溯源系统的快速索引算法

5.2.1 基于区块链的快速索引算法总体设计
本节针对现有区块链溯源系统中多数只是单区块查找以及顺序遍历等不足，提出一种基 于区块链的的快速索引算法。该算法分为三个部分，首先加入了重复索引机制，随着索引间 隔的增大以及时间的推移，缓存的数量也会随之减少，若用户在短期时间内多次查找相同珠 宝的溯源信息，可以直接从缓存中获得部分还存在的信息，而去区块链上查询只需查询到缓 存中的最后一个区块即可，并不需要遍历全部区块；其次，首先本文对区块体中交易数据节 点的存储结构进行修改，会先判断某珠宝是否为第一次交易，如果不是第一次交易，则将珠 宝的上一交易记录所在的区块生成的时间戳加入到当前交易的元数据中进行存储，在需要获 取该珠宝的上次交易区块时，根据区块距离模型计算出上次交易区块与当前区块之间大体间 隔了多少区块，从而能够在溯源过程中快速跳转定位到珠宝上一交易所在区块并取出详细交 易数据。最后，区块头中加入快速定位叶子节点模型，该快速定位叶子节点模型中采用数组 加链表的结构，生成区块时在该模型中分别通过公式计算下标位置 I，并在 I 中存储珠宝 ID 和对应的将其存储在区块体中 Merkle 树叶子结点的位置索引，在查询时，当输入 GID，通 过公式计算出下标位置 I，可以迅速到达 I 处返回一个 merkle 树中叶子节点索引位置，从而
42

南京邮电大学专业学位硕士研究生学位论文

第五章 基于区块链的珠宝交易溯源系统快速索引算法

快速定位到交易信息所在叶子结点索引取出交易信息，使得时间复杂度降低，查询效率大幅

度提高。本章将按照图 5.1 所示的流程对基于区块链的快速索引算法进行设计。

基于区块链的快速索引算法设计

重复索引机制

快速定位叶子节点模型

区块距离模型

控制缓存衰减

存储叶子节点索引位置

计算上个交易区块距离

减少重复查询

减少比对时延

减少遍历无用区块

图 5.1 基于区块链的快速索引算法设计流程图

5.2.2 基于区块链的快速索引算法详细设计

（1）重复索引机制

在进入区块链查询之前，会先通过部署在系统的用户层中的重复索引机制计算

CacheSum 来决定后续操作。该重复索引机制是随着索引间隔的增大以及时间的推移，缓存

的数量也会随之减少，所剩缓存数量计算公式如下：

￿￿￿(￿￿￿)￿￿￿￿￿￿⁄￿￿￿￿￿￿￿∗￿￿￿(￿￿￿)

퐶푎푐ℎ푒푆푢푚(퐺퐼퐷) = ￿

￿￿￿(￿￿￿)

0

푡 ≤ 60 푡 > 60

（5.1）

其中 GID 表示所溯源的奢侈品珠宝 ID；CacheSum 表示该奢侈品珠宝缓存数量占比；

Num(GID)表示该奢侈品珠宝全部区块信息数量；frequency 表示用户在最近一小时内查询的

次数，t 表示用户距离上次溯源的时间（min）。

为了减少重复查询同一奢侈品珠宝的无效消耗，则在该奢侈品珠宝短时间内被多次溯源

时，就会根据上诉公式 5.1 计算是否有衰减，衰减速度与短期内索引次数和距离上次溯源时

间有关。如果有衰减则先取出缓存中的部分交易信息，然后在表中取 lastBlockID(该奢侈品

珠宝最新区块 ID)并定位到该奢侈品珠宝信息的最新交易区块位置，然后向前依次查询，但

此时只需要查询到缓存最近交易所在区块位置即可，并不需要每次都查询到该奢侈品珠宝的

根源信息（即供应链信息）；如果无衰减即 CacheSum 计算出为 100% ，则直接取出所有交易

信息放入 result，并直接返回给页面展示。

43

南京邮电大学专业学位硕士研究生学位论文
（2）快速定位叶子节点模型

第五章 基于区块链的珠宝交易溯源系统快速索引算法

在每个区块头中都引入了快速定位叶子节点模型，存储模型图见下图 5.2。该存储模型

中存储数据的形式是采用数组加链表的结构，在生成区块时，会把 GID 和 Merkle 树叶子节

点索引位置 Tindex 分别存储在 I 下标位置的地址中，如果初始化时计算的 F(GID)位置已经

存在数据，则在该 I 位置上以链表的形式从尾部插入新的数据。在索引的时候通过公式 5.2

计算 F(GID)得到下标位置，可以直接到指定数组位置，校对 GID 一致后取出 Tindex 。I 的

计算公式如下：

I = 퐹(푘푒푦) = (퐻(푘푒푦)%100)&(퐿 − 1)

（5.2）

其中 key 为输入的奢侈品唯一溯源标识 ID，H(key)为字符串转化为唯一数字串的函数，

L 为数组长度；
NULL

GID Tindex

NULL

NULL

GID Tindex

GID Tindex

GID Tindex

0

1

2

3

4

5

存储地址I

I=F(GID)

GID
图 5.2 快速定位叶子节点存储模型图
并且在 Merkle 树中引入布隆过滤器数据结构[68]，它将元数据信息通过更加紧密的方式 进行存储，同时它还可以用来判断某个节点的 BF 集合中是否包含该 Tindex，使得定位 Merkle 树叶子节点过程中进行了剪枝操作，降低时间复杂度，提高定位节点效率。如下图 5.3 所示快速定位叶子节点模型结构图，根据 Merkle 树的构建方法，从叶子节点开始，相邻 的两个节点通过 hash 算法两两运算，从而得出 Merkle 树根的 Hash 值，并且在计算过程中将 结点的 Tindex 计算得出布隆过滤器 BF 存储在结点中。在查询某奢侈品对应的交易信息叶子 节点时，先从快速定位叶子节点存储模型中得出 Tindex，然后从 Merkle 树根结点开始比对，
44

南京邮电大学专业学位硕士研究生学位论文

第五章 基于区块链的珠宝交易溯源系统快速索引算法

如果该结点 BF 中存在 Tindex，则继续判断该节点的左右子节点的 BF 中是否存在所查询的

Tindex，如果存在则继续以此循环查询直到到达叶子节点取出该奢侈品珠宝对应的交易信息，

否则返回 None。

版本号

区块头

前一区块

前一区块hash 随机数

难度值 时间戳

快速定位叶子 节点存储模型
Merkle树根 BF5

节点10 Hash1-4 BF4

区块体

节点7 BF1
Hash1-2

节点8 BF2
Hash3-4

节点9 BF3
Hash3-4

节点1 Hash1
T0
交易1 T0

节点2 Hash2
T1
交易2 T1

节点3 Hash3
T2
交易3 T2

节点4 Hash4
T3
交易4 T3

节点5 Hash5
T4
交易5 T4

节点6 Hash6
T5
交易6 T5

图 5.3 快速定位叶子节点模型结构图
（3）区块距离模型 利用改变数据体中的存储结构，从而能够在查询完当前区块信息后，结合区块距离模型
快速定位奢侈品珠宝上一交易所在区块位置并取出详细交易数据，解决奢侈品珠宝多次交易 信息不连续区块的查询问题。在元数据中，将奢侈品的上一交易记录所在的区块的生成时间 戳，即 preBlockTimestamp 进行存储，元数据存储示意图如图 5.4 所示。

Tindex结构
preBlockTimeStamp(上次交易所 在区块生成时间戳) TID(交易ID) GID(奢侈品珠宝ID) TInformation(交易信息)

45

南京邮电大学专业学位硕士研究生学位论文

第五章 基于区块链的珠宝交易溯源系统快速索引算法

图 5.4 元数据存储示意图

区块距离模型可以实现查询完当前区块交易信息后通过元数据中的 preBlockTimestamp

和当前所在区块的 currBlockTimestamp 差值以及结合泊松分布计算出上次交易区块与当前区

块之间大体间隔了多少区块 DiffBlcokNum 来快速跳转至该奢侈品珠宝上次交易区块，解决

遍历链上大量无关区块所照成的时间浪费。其中区块距离计算公式如下：

￿￿￿￿￿

⎧ ⎪

￿

푃￿ ∗ 푁

푑 = 0;

퐷푖푓푓퐵푙표푐푘푁푢푚 = ￿￿￿￿￿￿ ⎨

￿￿

￿￿￿￿￿

⎪(푑 − 1) ∗ 푁 + ￿ 푃￿ ∗ 푁 + ￿ 푃￿ ∗ 푁 푑 ≥ 1

⎩

￿￿￿￿￿￿

￿￿￿

（5.3）

其中퐷푖푓푓퐵푙표푐푘푁푢푚 为上次交易所在区块和现在所在区块相差区块个数，푐푢푟푟푇 为当前

所在区块时间戳转为日期，푝푟푒푇 为上次交易所在区块时间戳转为日期，푑 为两个区块天数

的差值，푁

为本文假设每天平均区块链新增区块总数，푃￿

=￿￿￿

￿￿
表示该时间点产生区块的概

￿!

率。

为了尽量减少进入无关区块比对区块头中信息是否符合需求的时间消耗，系统中通过区

块距离模型返回 DiffBlcokNum，实现跳转相差 DiffBlcokNum 个区块高度位置的区块，有利

于提高整个溯源过程的索引速度。

5.2.3 快速索引算法实现流程

本小节以某个奢侈品珠宝溯源为例，阐述整个溯源索引流程步骤。设 G 代表某一奢侈 品珠宝，T 代表交易。快速索引算法溯源流程图见下图 5.5。
步骤 1：奢侈品 G 在从原料商流转时先进行厂家信息上链，并在每一个区块头中的快速 定位叶子节点机制中特定形式储存 GID(奢侈品 ID)和 Tindex(merkle 树对应的叶子节点索引 位置)，存储形式见图 5.2，同时在链下表中记录 lastBlockID（该商品最新区块 ID）和 lastBlockTimestamp（该商品最新区块生成的时间戳）。在发生奢侈品珠宝二次和后续多次流 转时，生成交易信息节点并把所交易商品的 lastBlockTimestamp 作为 preBlockTimestamp 字 段也存入其中,并同步更新链下表中数据。
步骤 1.1：如图 5.2 所示，本文假设计算出 F（GID）=1，在该区块 merkle 树中的叶子节 点为 T3，则把 GID 和 T3 存储在数组下标位置为 1 的地址中，如果 F(GID)数组中的 F(GID) 位置已经存在（即发生下标冲突），则以链表的形式在该数组位置插入新的数据块。
步骤 2：用户进入该系统输入奢侈品唯一标识 ID 进入系统溯源查询。
46

南京邮电大学专业学位硕士研究生学位论文

第五章 基于区块链的珠宝交易溯源系统快速索引算法

步骤 3：将步骤 2 输入的奢侈品唯一标识 ID 记为 GID 输入系统，根据上一节所述重复

索引机制，计算 CacheSum 来决定之后操作；如果有衰减则代表 GID 奢侈品的交易最新区块

lastBlockID 和缓存中的最新区块 cacheBlockID 不一致到步骤四，否则取出所有的交易信息

缓存放入结果集 result 并跳转至步骤 8。

步骤 3.1：由于第一次溯源，即 t 为+无穷，公式 5.1 得出 CacheSum 为 0，表示需要溯源

全部信息。但如果是短时间内多次溯源，如果就会根据公式 5.1 计算是否有衰减，如果有衰

减则继续以下步骤，如果无衰减即 CacheSum 计算出为 100% ，则直接取出所有交易信息放

入 result 跳转至步骤 8。

步骤 4：GID 奢侈品缓存已经衰减掉了一部分（即信息不完整），则先取出缓存中的部

分交易信息放入结果集 result，然后在表中取 lastBlockID(该商品最新区块 ID)并定位到该商

品信息的最新交易区块位置。

步骤 5：进去区块之后，通过区块头中的快速定位叶子节点模型以及输入的 GID 可以得

出该商品对应交易存储的 merkle 树叶子节点索引位置 Tindex，随后快速定位到交易信息所

在叶子结点取出交易信息放入结果集 result。

步骤 5.1：input 为 GID，利用上述公式 5.2 计算出 I=F(GID)即数组中下标位置，对比数

组中下标位置 I 中的头节点中存放的 GID 和 input 是否一致，若不一致，则继续校对该节点

链表的下一个节点位置，直到一致后取出数据中的 Tindex，随后 output 为 Tindex。

步骤 5.2：根据输出的 Tindex 以及节点中的 BF 过滤器实现快速定位 merkle 树对应商品

交易信息的节点位置，可以迅速取出在该区块中该商品对应的溯源信息，并放到结果集

result。

步骤 6：若该区块信息中存在 preBlockTimestamp (上次交易区块生成时间戳)，则通过

preBlockTimestamp 和当前所在区块的 currBlockTimestamp 差值以及区块距离模型计算出上

次交易区块与当前区块之间大体间隔了多少区块，从而能够在溯源过程中实现快速跳转到该

区块；若不存在 preBlockTimestamp 则表示已溯源至根部信息，则跳至步骤 8。

步骤 6.1：输入: preT , curT , N , d ; 根据公式 5.3 输出 DiffBlockNum；

步骤 6.2：根据上述输出为 DiffBlockNum 直接实现跳转相差 DiffBlockNum 个区块高度

位置的区块，不需要进入区块头进行比对查找；

步骤 7：进入跳转区块后，若 currBlockTimestamp（跳转到的区块的时间戳）与

preBlockTimestamp 不一致，则根据这两个时间戳再次根据上述区块距离模型计算区块间隔

实现跳转，直到 currBlockTimestamp 等于 preBlockTimestamp，然后并取出详细交易数据并

重复步骤六；
47

南京邮电大学专业学位硕士研究生学位论文

第五章 基于区块链的珠宝交易溯源系统快速索引算法

步骤 8：最终返回 result 给用户层进行溯源信息展示，同时对数据进行缓存。

根据以上面所述流程，下面给出本章的快速索引算法的流程伪代码如算法 2 所示。 算法 2：基于区块链的珠宝溯源快速索引

Input : 全部区块集合 Block，溯源珠宝唯一标识 GID

Output : 结果集合 Result

1、 初始化循环结束标记 flag = false;

2、 if CacheSum(GID) !=100% then 3、 b=Block.lastBlockID;

4、 Cache → Result;

5、 while flag is false do

6、

index= b.Array.F(GID);

7、

while index.GID !=GID do

8、

index=index.next;

9、 10、 11、 12、 13、 14、 15、 16、 17、 18、 19、

end tran=T[index.Tindex]; tran.information → Result; preT= tran. preBlockTimestamp; if preT then while b. currBlockTimestamp !=preT do b=Block.(CurrBlockNum-DiffBlockNum); end; continue; else flag=true;

20、 21、

end Block.remove();

22、 23、 24、

end else
Cache → Result;

25、 end 26、 return Result

48

南京邮电大学专业学位硕士研究生学位论文

第五章 基于区块链的珠宝交易溯源系统快速索引算法

算法 1 第 1 行初始化循环结束标记位 flag；第 2-23 行根据重复索引机制判断缓存是否有

衰减，若无衰减跳至 24 行取出缓存给 Result，若存在则至第 3 行跳转最新交易区块，第 4 行

取出剩余缓存至 Restlt,第 5 行循环至标记为 True,第 6 行根据快速定位叶子节点模型获得 GID

的数组下标位置，第 7-8 行一直比对下标位置链表节点中 GID 直至一致时，第 10 行根据

Tindex 取出交易信息，第 11 行将交易信息至于结果集，第 13-18 行若该 GID 存在上次交易

记录，则第 14-15 行利用区块距离模型根据区块号循环跳转区块直到区块中的时间戳和 preT

一致，否则将标志位 flag 置为 true 退出循环；第 26 行返回最终结果集 Result。在溯源过程

中可快速定位上次交易区块号并，对于传统区块链溯源方法来说，大大减少遍历无关区块，

对基于区块链的溯源系统效率有很大提升。本算法在溯源系统中保证了溯源商品信息时信息

真实可靠的同时，且不存在中心化管理溯源系统的透明度低以及用户信任危机的问题，也保

证了索引交易信息时的高效性。

49

南京邮电大学专业学位硕士研究生学位论文
进入溯源系统

第五章 基于区块链的珠宝交易溯源系统快速索引算法

输入奢侈品珠 宝唯一标识ID

重复索引机制

根据公式计算
CacheSum是否为 100%

取出部分缓 存至result,并 链下表中取 出lastBlockID
根据lastBlockID定位 到最新区块的位置
区块头中通过快速 定位叶子节点模型 根据输入的GID返 回对应的叶子节点
位置TIndex
根据TIndex到叶子节点位置 获取交易信息放入result中

元数据中是否包含

No

preBlockTimestamp

Yes
通过定位上次交易区块模型根据 currBlockTimestamp和
preBlockTimestamp计算出上次交易 区块到目前区块的间隔区块个数 DiffBlockNum

直接跳转至相差DiffBlockNum 个区块高度位置的区块

缓存中取溯 源信息result

重复索引机制
同时进行缓存该奢侈 品珠宝溯源信息

返回结果result

用户页面展示该奢侈 品珠宝所有信息
结束

区块头中时间戳是否和 preBlockTimestamp一致
Yes

No
图 5.5 快速索引算法溯源流程图 50

南京邮电大学专业学位硕士研究生学位论文
5.3 快速索引算法分析

第五章 基于区块链的珠宝交易溯源系统快速索引算法

本节将对本文提出的快速索引算法、传统 Merkle 索引方法和 MHerkle[63]索引方法进行

实验对比及分析，通过实验结果表明，本章提出的基于区块链的珠宝溯源系统的快速索引算

法效率最高。本章实验配置 Intel Core i7 的处理器、Ubuntu16.04.6 的操作系统、release-2.2

的 Hyperledger Fabric 底层区块链系统，节点部署在 Docker 容器环境中，使用 Dockerfile 产

生容器镜像，Docker-compose 启动联盟节点。

（1）生成区块时延实验

因为本文提出的快速索引算法对区块内部结构做了修改，从而不同索引方法生成区块消

耗时间影响着系统的运行效率，也表示着不同索引方法的实用性，生成区块消耗时间越低，

表示该索引方法在构建区块时的实用性更高。本节主要对比传统 Merkle 索引方法、MHerkle

索引方法以及本文提出的快速索引算法的生成区块的效率，通过 Curl 发送一样的交易数量

和指定区块数量的交易信息，记录从发起时到区块上链的时间来分析不同索引方法的区块生

成构建效率。本节将生成区块时延平均增长率公式化定义为 5.4：

퐷푇

=

￿ ￿

∑￿￿￿￿(￿￿￿￿￿)

￿ ￿

∑￿￿￿￿

￿￿

(5.4)

其中 W、V 分别表示为不同索引方法的构建时间的花费时间,DT 表示多次实验后的生成

区块时间平均增长率。

测试系统在给定交易数量为 128~8192 个和区块数量下进行生成区块时间计算，取 5-8

次实验结果平均值后分析实验结果，实验结果如下：

生成时间（ms）

1800

1600

1400

1200

1000

800

600

400

200

0

128

256

512

1024

2048

4096

8192

交易数量（个）

传统Merkle索引方法

MHerkle索引方法

本文快速索引算法

图 5.6 不同索引方案区块生成时延对比 51

南京邮电大学专业学位硕士研究生学位论文

第五章 基于区块链的珠宝交易溯源系统快速索引算法

在交易量逐渐递增下情况下，如图 5.6 所示，MHerkle 索引方法和本文快速索引算法相

比传统 Merkle 索引方法的区块生成时间增长较小，但本文快速索引算法比 MHerkle 索引方

法生成区块时间平均来说提升 12.6%左右。通过分析可知，因为本文的快速索引算法在结构

上来说与传统 Merkle 索引方法相比在区块头多引用了数组链表和布隆过滤器两种数据结构，

因此生成区块的时间会比传统 Merkle 索引方法慢一点，而 MHerkle 索引方法在生成区块时

添加了类似 B 树的结构，生成区块消耗的时间比本文快速索引算法要多，因此本文提出的

基于区块链的珠宝交易溯源系统的快速索引算法相较于其他索引算法有一定的实用价值。

(2) 索引速度实验

不同的区块链索引算法生成溯源信息时间快慢决定了系统执行的流畅性，也表示着不同

的区块链索引算法的执行效率。在测试实验中本文设置不同的参数变量进行测试，通过 curl

方式发送溯源查询请求，记录从索引发起时到奢侈品珠宝全部交易信息返回页面所生成溯源

结果的时间，对比分析本文提出基于区块链的珠宝交易溯源系统的快速索引算法的效率。实

验结果如下：

a) 设定条件初次查询，区块数量不变，单区块内交易节点增多情况下的消耗时间对比

消耗时间（ms）

35

30

25

20

15

10

5

0

128

256

512

1024

2048

4096

8192

单区块交易数量

传统Merkle索引方案

MHerkle索引方法

本文快速索引算法

图 5.7 初次查询时单区块交易数量递增的信息返回时间对比
如图 5.7 所示，展示了都在初次查询时不同的溯源索引方法随着单区块中交易数量递增 获取溯源结果的时间对比。在都是第一次查询某个奢侈品珠宝时，随着单区块交易数量递增， 传统 Merkle 索引算法完成整个溯源信息返回所花费时间呈指数性增长趋势，同时消耗时间 增长率加快，然而 MHerkle 索引方法的查询花费时间相对较少且随区块内交易量增多的增长 率低了很多，而本文提出的快速索引算法溯源花费时间更少并且增长率几乎稳定甚至趋于平
52

南京邮电大学专业学位硕士研究生学位论文

第五章 基于区块链的珠宝交易溯源系统快速索引算法

滑，通过分析传统 Merkle 索引算法是遍历所有区块和逐个对比交易获取结果集，消耗时间

为指数型增长；Mherkle 索引方法是通过引用 B 树所以比对交易时相对消耗时间减少了很多；

本文提出的快速索引算法通过元数据中交易节点存储的上次交易所在区块的生成时间戳和区

块距离模型以及 BF 过滤器和快速定位叶子节点模型来进行跨越式溯源，溯源效率较高。因

此本文提出的基于区块链的珠宝交易溯源系统的快速索引算法在初次查询条件下的效率更高。

b) 条件设定为区块数量和单区块内交易节点为 4000，重复溯源后查询间隔变长的消耗

时间对比。

消耗时间（ms）

18 16 14 12 10
8 6 4 2 0
0

15

25

40

60

75

105

与上次查询间隔时间（min）

传统Merkle索引方案

MHerkle索引方法

本文快速索引算法

图 5.8 重复溯源后查询间隔递增的信息返回消耗时间对比
如图 5.8 所示，展示了重复溯源后不同的索引方法随着查询间隔的递增获得溯源结果的 时间对比。在溯源过一次后，短期内对该珠宝再次进行溯源时，随着间隔时间的增加传统 Merkle 索引算法和 MHerkle 索引方法的查询花费时间变动相对较少，几乎速度一致，而本文 提出的快速索引算法溯源花费时间随着查询间隔时间增多平滑增长，在达到 60 分钟时消耗 时间达到最高点，后续趋于平滑，虽然消耗时间在增多，但最大消耗时间比前两种索引方法 消耗时间少，索引速度快。通过分析因为缓存索引机制的问题，所以本文提出的快速索引算 法在间隔时间为 0 时，只需将上次查询的缓存返回即可，大大减少时间消耗，查询消耗时间 会随着所剩缓存数的变少而增多，但本文的快速索引算法查询最慢时间比传统的索引和 Mherkle 索引方法都要快。
c) 条件设定为需要找到 6 次在不同区块的流转交易的信息，初次溯源，但区块链区块 数量增多的消耗时间对比。

53

南京邮电大学专业学位硕士研究生学位论文

消耗时间（ms）

160

140

120

100

80

60

40

20

0

100

200

300

第五章 基于区块链的珠宝交易溯源系统快速索引算法

400

500

600

700

区块数量

传统Merkle索引方案

MHerkle索引方法

本文快速索引算法

图 5.9 查询多区块数据随区块数量递增下的信息返回消耗时间对比
如图 5.9 所示，展示了查询多区块数据时不同的索引方法随着账本中区块数量的递增获 得溯源结果的时间对比。都是初次溯源的情况下，随着区块数量的增多，传统 Merkle 索引 算法完成整个溯源信息返回所花费时间呈指数性增长趋势，消耗时间增长率加快，而 MHerkle 索引方法的查询花费时间相对较少且保持线性增长，而本文提出的快速索引算法溯 源花费时间在区块数量达到 300 个后比前两种都少，并且增长率比 Mherkle 要低。通过分析 传统 Merkle 索引算法是逐个遍历全部区块，消耗时间为指数型增长；Mherkle 索引方法是通 过引用 B 树所以比对交易时相对消耗时间减少了很多；而本文提出的快速索引算法通过元数 据中交易节点存储的上次交易所在区块的生成时间戳和区块距离模型实现跳跃式溯源，减少 访问无效区块，溯源效率较高。因此本文提出的基于区块链的珠宝交易溯源系统的快速索引 算法在初次查询条件下的效率更高。

5.4 本章小结

本章首先对珠宝交易溯源系统中存在的问题进行分析，接着阐述了国内外现有的一些查 询优化的解决方案。针对存在的问题，提出了一种基于区块链的快速索引算法并进行整体设 计。然后分别从重复索引机制、快速定位叶子节点模型以及区块距离模型三个方面对快速索 引算法进行详细设计，并且阐述了该快速索引算法的整个实现流程步骤以及对该算法的优势 进行分析。最后，从区块生成速度和溯源速度两个方面的对比试验证明了该索引算法的优越 性，适用于本文珠宝交易溯源领域应用。

54

南京邮电大学专业学位硕士研究生学位论文

第六章 系统实现与测试

第六章 系统实现与测试

本章对基于区块链的珠宝交易溯源系统进行实现与测试，将第四第五章分别提出的低通 信成本 LC-PBFT 共识算法和交易信息快速索引算法应用在系统中。首先对系统环境进行介 绍并进行环境搭建和代码部署，然后实现系统主要功能模块并展示，最后对系统的各个功能 模块进行测试。

6.1 开发环境

6.1.1 硬件环境

本文的溯源系统所依赖的硬件环境包括开发环境、数据库服务器、代码服务器和 IPFS

系统。其中，开发环境主要时在本地对系统前后端逻辑代码进行开发，数据库服务器用来存

储系统数据，将前端页面代码打包成 dist 文件以及后台逻辑代码打包上传至代码服务器中，

IPFS 系统主要负责分布式存储文件数据返回哈希。具体的系统硬件环境如下表 6.1 所示。

表 6.1 系统硬件环境配置 开发环境硬件配置

属性 CPU 内存 操作系统

服务器环境

参数 i7-9700k
16GB Win10 64 位

设备 CPU 内存 操作系统

阿里云服务器 i7-9700k 16GB
Ubuntu16.04.6 64 位

6.1.2 软件环境
本文对珠宝交易溯源系统进行开发时的软件环境主要包括前端页面开发、后台逻辑开发、 数据库工具等，具体的版本如表 6.2 所示：
表 6.2 软件环境配置 55

南京邮电大学专业学位硕士研究生学位论文 开发工具

前端开发

Vscode

后端开发

IDEA

数据库开发

MySQL

版本控制

Git

开发框架

前端框架

Vue-cli、router

后端框架

SpringBoot

服务器

Tomcat

开发语言

前端语言

Javascript

后端语言

Java

第六章 系统实现与测试
1.61 2021.1 8.0.20 2.34.0
2.x 2.4.0 Apache-tomcat-9.0.41
ECMAScript 2018 JDK 1.8.0

6.2 环境配置与部署

6.2.1 Hyperledger Fabric 网络环境部署
Hyperledger Fabric 是目前已经非常成熟的区块链开发架构,由于具有可插拔、独立通道 和可扩展性等特点,所以常被应用于企业联盟链技术的研究领域。
首先在 Ubuntu 系统中安装 Docker 环境，然后下载 Fabric 2.2 版本源码并解压，解压后 列 表 如 图 6.1 所 示 。 然 后 进 入 ~/gowork/go/src/github.com/hyperledger/fabric/sripts/fabricsamples/ first-network/trace 执行 byfn.sh 脚本启动 Fabric 网络，过程如图 6.2 所示。图 6.3 表 示节点启动状态。图 6.4 表示区块链网络已经成功部署完毕。

图 6.1 Fabric 源码列表 56

南京邮电大学专业学位硕士研究生学位论文

第六章 系统实现与测试

图 6.2 Fabric 网络启动
图 6.3 启动节点状态
图 6.4 Fabric 网络部署成功
6.2.2 IPFS 部署
Ubuntu 控制台中 wget 下载 go-ipfs 并解压，接着通过 ipfs init 对 IPFS 节点进行初始化， 系统会随后生成名为.ipfs 的文件夹来存放节点数据。初始化如下图 6.5 所示。
57

南京邮电大学专业学位硕士研究生学位论文

第六章 系统实现与测试

图 6.5 初始化 ipfs
然后配置 CORS 跨域资源共享并执行 ipfs daemon 启动 IPFS，见下图 6.6。 ipfs config --json API.HTTPHeaders.Access-Control-Allow-Methods '["PUT", "GET", "POST", "OPTIONS"]' ipfs config --json API.HTTPHeaders.Access-Control-Allow-Origin '["*"]' ipfs config --json API.HTTPHeaders.Access-Control-Allow-Credentials '["true"]' ipfs config --json API.HTTPHeaders.Access-Control-Allow-Headers '["Authorization"]' ipfs config --json API.HTTPHeaders.Access-Control-Expose-Headers '["Location"]'

图 6.6 启动 ipfs
另开一个终端，输入 ipfs cat /ipfs/QmS4ustL54uo8FzR9455qaxZwuMiUhyvMcX9Ba8nUH4uVv /readme，图 6.7 可以看到 IPFS 配置成功。
58

南京邮电大学专业学位硕士研究生学位论文

第六章 系统实现与测试

图 6.7 成功安装 ipfs
6.2.3 LC-PBFT 共识算法部署
共识算法代码都在如下图 6.8 所示的 consensus 文件夹里，consensus 文件夹里主要分为 controller，executor，helper，noops，lc-pbft，util 文件模块。其中 controller 决定选取什么共 识算法，executor 主要负责事件处理的转接。helper 主要执行处理 transaction 等。本系统部 将第四章设计的 LC-PBFT 共识算法进行部署，因此内部通过命令 controller .NewConsenter (engine.helper) 来进行初始化 LC-PBFT 共识算法。
59

南京邮电大学专业学位硕士研究生学位论文 图 6.8 共识模块目录结构
6.2.4 智能合约部署

第六章 系统实现与测试

将如下图 6.9 所示的 go 语言编写的自动化执行代码封装成对应的智能合约例如 basic.go, 启动 cli 和节点后执行 peer chaincode install -n basic -v 1.0-p github.com/chaincode/basic 指令将 basic.go 安装在 docker 容器中。安装过程如下如图 6.10 所示。

图 6.9 智能合约

6.2.5 代码部署

图 6.10 智能合约部署

将前端页面代码打包成 dist 文件以及后台逻辑代码打包并上传部署到服务器中，同时初
60

南京邮电大学专业学位硕士研究生学位论文

第六章 系统实现与测试

始化服务器代码，用户可以从远程客户端来进入系统进行一系列操作。

6.3 系统功能实现与测试

6.3.1 系统功能实现
（1） 登录注册模块 在浏览器输入珠宝交易溯源系统的网址，进入系统登录页面，输入登录账号、密码和验
证码后，点击登录按钮，然后后端对输入的账号进行查询，因为用户密码在数据库中是加密 后存储的，若查到账号后，对用户输入的密码采用同样的加密函数进行转码然后进行验证， 验证通过后成功登录珠宝交易溯源系统，本文系统使用了 SpringSecurity 技术进行用户身份 验证，并跳转至该用户对应不同角色的不同主页。如果还没账号的话点击去注册按钮跳转到 注册页面，如果是只想进行溯源查询的普通消费者，可以直接点击游客登录按钮，进入系统 只可以进行溯源珠宝信息。具体登陆页面如下图 6.11 所示

图 6.11 用户登录页面 注册界面主要是针对不同的用户角色提交不同的注册信息给后台，然后管理员登录系统 进行审核，审核后系统根据提交的资料对用户进行角色分配，并对信息进行上链。监管部门 需要输入用户名、密码、监管部门代号、监管部门名称以及监管部门相关证明材料等，具体 页面信息如 6.12 所示。
61

南京邮电大学专业学位硕士研究生学位论文

第六章 系统实现与测试

图 6.12 监管部门注册页面
企业机构需要输入用户名、密码、企业编号、企业名称以及企业经营许可等证明材料等 具体页面信息如 6.13 所示。

图 6.13 企业机构注册页面
消费者需要输入用户名、密码、真实姓名、个人身份证号等，具体页面如 6.14 所示。
62

南京邮电大学专业学位硕士研究生学位论文

第六章 系统实现与测试

图 6.14 消费者注册页面
（2） 身份审核模块 在用户输入注册信息提交给系统后，管理员可以在其特定系统页面中对申请信息进行审
核，审核通过后点击提交将用户信息当作一个交易信息上传至区块链中进行存储并更新该用 户信息的区块地址，并且管理员可以对已注册用户进行监控以及珠宝异常查询操作检查，然 后进行追究等。具体的用户审核页面如下图 6.15 所示。

图 6.15 用户审核页面 63

南京邮电大学专业学位硕士研究生学位论文

第六章 系统实现与测试

在用户管理页面管理员可以看到所有的注册成员信息，并且列表中还展示了该用户信息

在链上存储的区块哈希地址，防止用户恶意操作后对自己个人信息做篡改，保证用户可追溯。

具体用户管理页面如下图 6.16 所示：

图 6.16 用户管理页面
（3） 数据录入模块 在企业用户登录系统后，进入该企业角色对应的页面，下面以生产商为例，可以进行信
息录入和上传信息查询、修改密码、问题反馈等功能。首先由生产商在系统网页录入信息模 块把珠宝的相关加工信息填写后通过 post 请求发送给后台，后台通过 security 安全模块对发 送请求的身份进行验证是否为已注册的生产商。验证身份通过后取出提交的原材料来源和原 材料序列号并通过 Fabricsdk 调用智能合约查询原材料是否存在，若不存在则录入失败，返 回页面重新提交，如果验证通过，则将输入信息和最新区块时间戳一起录入，进入交易池中 等待生成区块并完成共识生成账本，在上链成功后根据返回的最新区块相关信息同步更新到 链下数据库中。具体信息录入页面如下 6.17 所示。
64

南京邮电大学专业学位硕士研究生学位论文

第六章 系统实现与测试

图 6.17 生产商信息录入页面
（4） 数据查询模块 企业机构中以生产商为例，生产商在信息录入后对自己录入的信息进行查询，输入产品
溯源码后，将请求发送给系统后台，后台先对发起请求的用户角色权限进行判断，后台通过 执行本文提出的快速索引算法，对该溯源码对应的珠宝相关的区块信息进行查询并以 result 结果集返回给前端，前端通过判断该珠宝的生产商 id 和发起请求的生产商 id 进行对比，在 身份认证一致后直接展示相关信息在生产商查询页面，生产商不可以查询其他生产商的珠宝 信息。具体生产商查询页面见下图 6.18。
65

南京邮电大学专业学位硕士研究生学位论文

第六章 系统实现与测试

图 6.18 生产商查询页面
消费者中以正常未登录进行溯源为例，未登录消费者进入系统溯源页面后，输入相关产 品溯源码，发送查询请求，后台通过执行本文提出的快速索引算法，对该溯源码对应的珠宝 相关的区块信息进行查询并以 result 结果集返回给前端，会记录该 ip 地址的查询次数进行累 加，短期最多可以连续溯源 10 次。具体查询页面如下图 6.19-6.20。

图 6.19 未登录消费者查询页面 1 66

南京邮电大学专业学位硕士研究生学位论文

第六章 系统实现与测试

图 6.20 未登录消费者查询页面 2

6.3.2 系统功能测试

（1） 登录注册功能测试

登录注册模块的测试主要是对系统中不同需求角色的注册接口进行测试，注册请求是否

可以被管理员审核页面列表获取，测试结果如下表 6.3 所示：

测试案例

表 6.3 注册功能测试 预期结果

测试结果

注册消费者账号

注册成功，管理员收到审核

符合预期

注册企业机构账号

注册成功，管理员收到审核

符合预期

注册监管部门账号

注册成功，管理员收到审核

符合预期

输入错误格式手机号

注册失败，提示手机号错误

注册失败，手机号一行报红

注册两次密码输入不一致

注册失败

注册失败，提示密码不一致

注册企业和监管部门不上传证明 注册失败，提示请上传材料证明

材料

身份

注册失败，请上传证明材料

注册消费者输入错误格式身份证 号

身份证号有误

注册失败，请输入正确的身份证 号

注册完成后进行登录测试，主要测试密码，验证码等是否功能正常，具体测试结果如下 表 6.4 所示：

67

南京邮电大学专业学位硕士研究生学位论文

测试案例

表 6.4 注册功能测试 预期结果

登录时密码是否加密显示

密码加密显示

不同身份角色登录后是否到达自 己的主页

每个角色展示不同的主页

输入错误验证码

验证码错误登录失败

用户正常登录

登录成功

输入不匹配的密码

登录失败

第六章 系统实现与测试
测试结果 密码以符号显示
符合预期 验证码错误，重新输入
符合预期 登录失败，提示请重新输入密码

（2） 身份审核功能测试

管理员的身份审核模块的测试，主要看是否可以收到注册用户信息，审核是否符合规范，

提交后注册信息是否上链存储。具体测试结果如下表 6.5 所示：

测试案例

表 6.5 身份审核功能测试 预期结果

测试结果

密码是否加密显示

密码加密显示

密码以符号显示

消费者身份证号是否安全显示 附件资料是否可以打开

显示部分身份证号 可以打开查看资料

后四位以 x 显示 符合预期

搜索框是否可以根据用户名、类 型等进行筛选

展示符合预期的列表

只展示筛选后的信息

提交后注册用户信息是否在区块 链上进行存储

链上存在用户信息

提交后根据返回的区块地址可以 查到用户信息

（3） 数据录入功能测试

数据录入模块功能测试，主要是对珠宝流转环节中不同角色的企业机构信息录入进行测

试，并对录入信息返回时间进行记录来测试第四章的共识算法的时间，具体测试结果如下表

6.6 所示：

测试案例

表 6.6 数据录入功能测试 预期结果

测试结果

原料商数据录入

录入成功

返回原料信息区块位置

生产商数据录入

录入成功

返回溯源码以及更新数据表

仓储数据录入

录入成功，更新表

符合预期

经销商数据录入

录入成功，记录生产商信息

录入成功，链上根据返回哈希可 以查出交易信息

零售商数据录入

录入成功，记录交易信息

录入成功，交易信息上链

交易信息上链速度是否合理

160s 后返回上链成功

符合预期

68

南京邮电大学专业学位硕士研究生学位论文
（4） 数据查询功能测试

第六章 系统实现与测试

数据查询模块功能测试主要是对未登录和登录两种状态进行查询测试，并对查询信息返

回时间进行记录来测试第五章的查询算法效率。具体测试结果如下表 6.7 所示：

测试案例

表 6.7 数据录入功能测试 预期结果

测试结果

未登录消费者输入查询码是否显 示溯源信息

显示所有相关交易流转信息

显示所有环节信息

未登录消费者连续查询超过十次 是否禁止

无法继续查询

为防止恶意查询，请登陆后继续 查询

企业机构查询是否可以查看其他 同角色的珠宝

无法查询

因珠宝录入的生产商 id 不一致， 无法查询

输入错误溯源码查询

无法查询

提示输入的溯源码有误，请输入 正确的珠宝溯源码

监管部门是否可以对珠宝进行监 管

可以查看管理审核

符合预期

短期重复溯源速度是否合理

溯源信息返回时间 300ms

页面返回信息速度快，符合预期

上述对基于区块链的珠宝交易溯源系统的各个功能模块功能进行测试，测试结果表明系

统功能都可以正常运行。同时根据上述测试结果可以看出 LC-PBFT 共识算法对信息上链速 度有显著提高以及快速索引算法对系统的溯源信息查询返回的速度也有很大提升，适用于本

文珠宝交易溯源系统的场景。

6.4 本章小结

本章对基于区块链的珠宝交易溯源系统的实现过程进行介绍。首先说明本文系统的硬件 和软件配置环节，然后对系统进行部署，包括 Fabric 底层网络部署、IPFS 部署和前后端代 码上传部署等，最后对本课题的基于区块链的珠宝交易溯源系统系统的各功能页面进行实现 并测试，证明系统的可用性、可靠性。

69

南京邮电大学专业学位硕士研究生学位论文
第七章 总结与展望

第七章 总结与展望

7.1 总结
随着区块链技术的应用溯源领域发展研究以及对奢侈品珠宝交易溯源的需求分析，在珠 宝交易溯源系统中运用具有分布式、链式结构、去中心化、防篡改等特性的区块链技术已经 成为必然的趋势。在传统的奢侈品珠宝溯源系统中，所有的交易信息都是存储在某中心管理 企业的集权服务器上，非常容易被内部人员篡改和作假，从而导致溯源信息不可信，出现大 量假货充当真货的现象。因此，本文对融入区块链技术的珠宝交易溯源系统进行研究，主要 工作总结如下：
（1） 首先对基于区块链的珠宝交易溯源系统所涉及到的底层相关技术进行介绍，并 且对目前传统的珠宝交易溯源系统和基于区块链技术的其他领域溯源系统相关文献进行研究 与分析，然后对现有的基于区块链的奢侈品珠宝领域的溯源防伪等进行研究与分析。
（2） 根据软件开发的思路结合珠宝交易业务流转过程对本文溯源系统总体架构进行 设计，然后提出本文相对于现有的区块链溯源系统的所需改进点，并根据功能需求对系统进 行模块划分，并对各个模块进行分析，然后根据珠宝业务场景需求设计出数据库关联图。
（3） 分析了传统的共识算法应用在本文珠宝交易溯源场景下的通信复杂度过高以及 性能不足的问题，系统中联盟节点日益增多，在共识过程中，节点间通信复杂度线性增大， 导致通信成本过高，不利于区块链珠宝交易溯源系统的高效工作，不能达到本文溯源系统场 景的使用要求。为了改善这一现象，减少节点间通信复杂度并保证共识效率，本文制定了基 于多层分组的低通信成本共识算法 LC-PBFT，引入节点属性多层分组模型和分层递归共识 过程以及末层 raft 共识，使得系统节点共识通信成本大幅度降低同时改善了算法吞吐量以及 时延。实验证明，LC-PBFT 共识算法可以达到珠宝交易溯源的应用场景。
（4） 研究了现有区块链溯源系统的区块溯源索引过程，分析出传统溯源和现有改进 的相关文献还存在的不足，系统中交易区块越来越多、用户重复查询、多区块查询因区块链 式结构导致查询交易信息返回速度低下，影响用户体验，不利于区块链珠宝交易系统的高效 工作，不能达到本文溯源系统场景的使用要求。为了改善查询索引速度，本文提出一种基于 区块链的快速索引算法，引入重复索引机制、快速定位叶子结点模型和区块距离模型，使得 溯源索引过程更加高效，减少用户发起请求后的返回时间成本，提高用户体验。最后通过生 成区块时延、单区块索引速度、多区块索引速度实验等证明了该快速索引方案的可行性。
70

南京邮电大学专业学位硕士研究生学位论文

第七章 总结与展望

（5） 最后对本文的基于区块链的珠宝交易溯源系统各个功能模块进行实现，并对各

个功能模块进行测试。

7.2 展望

虽然完成了基于区块链的珠宝交易溯源系统的开发与测试，但是系统的安全性、响应性 能和用户体验还有一些提升空间，同时区块链技术在不断发展，所以本文的溯源系统也值得 更深入的探讨。因此，接下来的的研究工作主要从下面几个方面进行改善与发展：
（1） 本文系统的创新优化都是关注效率方面问题，下一步应该考虑如何加强系统的 安全性以及信息保密性。
（2） 本文设计的 LC-PBFT 共识算法是基于多层分组的递归共识过程策略，对联盟链 中角色比例不平衡的情况没有进行深入的探讨，下面应该对算法在不同情况的共识分组进行 优化并且考虑代码的复杂度。
（3） 本文设计的快速索引算法是基于区块距离模型和快速定位叶子结点模型进行快 速定位区块和叶子结点，下一步需要考虑降低快速索引算法的复杂度，同时确保快速索引算 法的安全性。
（4） 系统测试只是通过黑盒测试的形式来对模块功能是否可以正常使用进行测试以 及返回速度测试，没有通过白盒测试对代码进行优化，也没有对系统的安全性、兼容性进行 测试，也没有进行压力测试，接下来需要进一步测试。
（5） 系统的前端用户使用页面的美观还需要改善，部分非需求功能也需逐渐完善。

71

南京邮电大学专业学位硕士研究生学位论文
参考文献

参考文献

[1] Satoshi Nakamoto.Bitcoin: A Peer-to-Peer Electronic Cash System[EB].https://bitcoin.org/bitcoin.pdf, 2009. [2] Zhimin Gao,Lei Xu,Lin Chen,Xi Zhao,Yang Lu,Weidong Shi. CoC: A Unified Distributed Ledger Based
Supply Chain Management System[J]. Journal of Computer Science and Technology,2018,33(2). [3] 沈鑫, 裴庆祺, 刘雪峰. 区块链技术综述[J]. 网络与信息安全学报, 2016, 2(11):11-20.
[4] 陈佳华. 联盟区块链的容量优化模型研究[D].大连海事大学,2018.
[5] Szydlo M. Merkle tree traversal in log space and time[C]. International Conference on the Theory and Applications of Cryptographic Techniques. Springer, Berlin, Heidelberg, 2004: 541-554.
[6] Angelin Gladston,Arun Prasad Mohan, Mohamed Asfak R.Merkle Tree and Blockchain-BasedCloud Data Auditing[J]. International Journal of Cloud Applications and Computing,2020:54-66.
[7] 吴梦宇,朱国胜.基于 Merkle 树的区块链数据修改方法研究[J].信息通讯,2020(10):10-16. [8] 袁 勇 , 倪 晓 春 , 曾 帅 , 王 飞 跃 . 区 块 链 共 识 算 法 的 发 展 现 状 与 展 望 [J]. 自 动 化 学 报 ,2018,44(11):2011-
2022.DOI:10.16383/j.aas.2018.c180268. [9] Arthur Gervais,Ghassan O. Karame,Karl Wüst,Vasileios Glykantzis,Hubert Ritzdorf,Srdjan Capkun. On the
Security and Performance of Proof of Work Blockchains[P]. Computer and Communications Security,2016. [10] King S , Nadal S . PPCoin: Peer-to-Peer Crypto-Currency with Proof-of-Stake. 2012. [11] Bentov I,Lee C,Mizrahi A,et al.Proof of Activity:Extending Bircoins Proof of Work via proof of
Stake[J].Acm Sigmetrics Performance Evaluation Review,2014,42(3):34-37 [12] King S,Nadal S.Ppcoin:Peer-topeer crypto-currency with proof-of-stake[J].self-published paper
August,2012:19-23 [13] BitShares. Delegated proof of stake [Online], available: https://bitshare s.org/technology/delegated- proof-
of-stake-consensus/ ,2014. [14] Miguel O . Practical Byzantine Fault Tolerance. 2001. [15] K. Christidis and M. Devetsikiotis, "Blockchains and Smart Contracts for the Internet of Things," in IEEE
Access, vol. 4, pp. 2292-2303, 2016, doi: 10.1109/ACCESS.2016.2566339. [16] 艾丹, 冉文学, 胡德慧,等. 基于 EPC 物联网的奢侈品防伪流程优化研究[J]. 物流技术, 2012, 31(9):4. [17] 舒非凡. LV品牌演绎防伪经典[J]. 中国品牌与防伪, 2010(10):4. [18] 李达. 腕表表盒新型防伪设计[J]. 中国包装工业, 2015(6X):1. [19] 佚名. 我国名牌奢侈品防伪市场尚待开发[J]. 中国防伪, 2005(2):1. [20] 刘振鲁,赵志敏,俞晓磊.应用于液体类商品的RFID标签贴放位置优化设计[J].测控技术,2018,37(10):18-
21.DOI:10.19708/j.ckjs.2018.10.004. [21] Kristoffer F , David S . The Supply Chain Has No Clothes: Technology Adoption of Blockchain for Supply
Chain Transparency[J]. Logistics, 2018, 2(1):2-. [22] Ongena G , Ravesteyn P , Hilten M V . Blockchain for Organic Food Traceability: Case Studies on Drivers
and Challenges[J]. Frontiers in Blockchain, 2020. [23] Law A. Smart contracts and their application in supply chain management[J].Massachusetts Institute of
Technology,2017. [24] Hackius N , Petersen M . Translating High Hopes into Tangible Benefits: How Incumbents in Supply Chain
and Logistics Approach Blockchain[J]. IEEE Access, 2020, 8(1):34993-35003. [25] Michael White. A global trade platform using blockchain technology aimed at improving the cost of
transportation, lack of visibility and inefficiencieswith paper-based processes[EB/OL]. 2018. https://www.ibm.com/blogs /blockchain /2018/01/digitizing-global-trade-maersk-ibm/. [26] Caro M P , Ali M S , Vecchio M , et al. Blockchain-based traceability in Agri-Food supply chain management: A practical implementation[C]// 2018:1-4.
72

南京邮电大学专业学位硕士研究生学位论文

参考文献

[27] David Galvin. IBM and Walmart: Blockchain for Food Safety[R]. IBM Blockchain, 2017.

[28] O'brien John, Winkle David, Atchley Michael, et al. Autonomous drone and tool selection and delivery[P].

United States Patent: 62240613, 2017.

[29] Jamil F,Hang L,Kim K K, et al.A novel medical block chain model for drug supply chain integrity

management in a smart hospital[J].Electronics,2019,8(5):505.

[30] Everledger. A Digital Global Ledger.Accessed On Aug. 1,2017. [Online].

[31] Blockverify. Block Verify. Accessed on Aug. 1,2017[Online]

[32] 盛琪.基于区块链的供应链信息平台构建[J].物流技术,2021,40(08):90-94.

[33] 曹杰, 詹赵林, 张金龙. 区块链防伪平台设计与实践[J]. 金融电子化, 2017(1):2.

[34] 丁庆洋, 朱建明. 区块链视角下的B2C电商平台产品信息追溯和防伪模型[J]. 中国流通经济, 2017,

31(12):9.

[35] 中国信息通信研究院. 区块链溯源应用白皮书(1.0 版本)[R]. 2018.

[36] 刘家稷, 杨挺, 汪文勇. 使用双区块链的防伪溯源系统[J]. 信息安全学报, 2018, 3(3):13.

[37] 刘耀宗, 刘云恒. 基于区块链的RFID大数据安全溯源模型[J]. 计算机科学, 2018, 45(B11):3.

[38] 李保东, 叶春明. 基于区块链的汽车供应链产品追溯系统[J]. 计算机工程与应用, 2020, 56(24):8.

[39] 乔蕊, 曹琰, 王清贤. 基于联盟链的物联网动态数据溯源机制[J]. 软件学报, 2019, 30(6):18.

[40] 刘雅东. 基于区块链的溯源信息存储平台的研究与实现[D]. 北京邮电大学.

[41] Wang Y , Song Z , Cheng T . Improvement Research of PBFT Consensus Algorithm Based on Credit[M].

Springer, Singapore, 2019.

[42] Gan J , Qiang L I , Chen Z , et al. Improvement of blockchain practical Byzantine fault tolerance consensus

algorithm[J]. Journal of Computer Applications, 2019.

[43] 刘肖飞.基于动态授权的拜占庭容错共识算法的区块链性能改进研究[D].浙江大学,2017.

[44] Jia D Y , Xin J C , Wang Z Q , et al. Efficient Query Model for Storage Capacity Scalable Blockchain

System[J]. Journal of Software, 2019.

[45] Yadav A S , Kushwaha D S . Query Optimization in a Blockchain-Based Land Registry Management

System[J]. Ingénierie des Systèmes D Information, 2021, 26(1):13-21.

[46] 于尧, 张中源. 面向信誉-行为关联双区块链的可验证查询优化方法:中国,202110839618[P],2021.

[47] 郭珊珊.供应链的可信溯源查询在区块链上的实现[D].大连海事大学,2017.

[48] Diamond Time-Lapse Do You Know Your Diamond[EB/OL]. 2016. https://diamonds.everledger.io/.

[49] 陈 新 林 , 王 政 铭 . 一 种 基 于 区 块 链 和 NFC 芯 片 的 动 态 信 息 防 伪 技 术 [J]. 物 联 网 技 术 ,2018,8(03):67-

69.DOI:10.16667/j.issn.2095-1302.2018.03.017.

[50] Biswas K , Muthukkumarasamy V , Tan W L . Blockchain Based Wine Supply Chain Traceability

System[C]// Future Technologies Conference. 2017.

[51] Rui A N , De-Biao H E , Zhang Y R , et al. The Design of an Anti-Counterfeiting System Based on

Blockchain[J]. Journal of Cryptologic Research, 2017.

[52] 苏丹丹, 汪丁牧野, 谢宇韬. 区块链:奢侈品高贵血统的守护者[J]. 合作经济与科技, 2020(2):2.

[53] 何玺. 奢侈品的'身份证'[J]. 现代企业文化, 2018(22):2.

[54] 陈昱. 珠宝物证一体追溯模块:, CN209842685U[P]. 2019.

[55] 蚂 蚁 金 融 科 技 . 区 块 链 在 天 猫 国 际 商 品 溯 源 中 的 应 用 [Online], 阿 里 云 开 发 社 区 ， 2018 ，

https://developer.aliyun.com/article/348787.

[56] Yong K L , Batina L , D Singelee, et al. Anti-counterfeiting, Untraceability and Other Security Challenges

for RFID Systems: Public-Key-Based Protocols and Hardware[M]. Springer Berlin Heidelberg, 2010.

[57] 吴晓彤. 基于区块链的农产品可信溯源系统研究与实现[D]. 山东农业大学, 2020.

[58] Jiang Yuyan, Shao Jin, Lu Wei. An improved PBFT algorithm for supply chain traceability applications [J].

Journal of Anhui University of Technology (Natural Science Edition), 2021, 38(01): 111-117.

[59] Zhou Xiuxiu. Research on food information traceability based on blockchain [D]. Chongqing:

73

南京邮电大学专业学位硕士研究生学位论文

参考文献

Chongqing University of Posts and Telecommunications, 2020.

[60] Zheng X , Feng W , Huang M , et al. Optimization of PBFT Algorithm Based on Improved C4.5[J].

Mathematical Problems in Engineering, 2021, 2021(2):1-7.

[61] 袁 晓 伟 . 基 于 拜 占 庭 容 错 混 合 共 识 机 制 的 联 盟 链 研 究 与 应 用 [D]. 青 岛 理 工 大 学 ,2020.

DOI:10.27263/d.cnki.gqudc.2020.000300.

[62] 陈忠贤,李秦伟,罗婧雯.基于通信时间分组的PBFT算法改进[J].计算机与数字工程,2021,49(04):711-717.

[63] 郑浩瀚, 申德荣, 聂铁铮,等. 面向混合索引的区块链系统的可查询性优化[J]. 计算机科学, 2020, 47(10):8.

[64] 李楠. 区块链查询技术优化[J]. 电脑知识与技术：学术版, 2021, 17(11):3.

[65] Ruan P , Dinh T , Lin Q , et al. LineageChain : a fine-grained, secure and efficient data provenance system

for blockchains[J]. The VLDB Journal, 2021, 30(1):3-24.

[66] Yang L , Kai Z , Ying Y , et al. EtherQL: A Query Layer for Blockchain System[C]// International

Conference on Database Systems for Advanced Applications. 2017.

[67] Mongodb[EB/OL].https://www.mongodb.org.

[68] Bloom Burton H. Space/time trade-offs in hash coding with allowable errors [J]. Commun ACM, 1970, 13 7 :

422–426.

74

南京邮电大学专业学位硕士研究生学位论文

附录 1 攻读硕士学位期间申请的专利

附录 1 攻读硕士学位期间申请的专利

[1] 宫婧，王文豪，孙知信.基于联盟链的商品溯源系统的快速索引方法，202210137278.8， 2022.02；

75

南京邮电大学专业学位硕士研究生学位论文

附录 2 攻读硕士学位期间参加的科研项目

附录 2 攻读硕士学位期间参加的科研项目

（1） 校企合作项目，基于区块链的跨链交易平台； （2） 校企合作项目，人工智能在线教育平台；

76

南京邮电大学专业学位硕士研究生学位论文

致谢

致谢

时间飞逝，三年硕士研究生生涯落下帷幕，即将步入下一个人生阶段。隐约记得 2019 年拿着录取通知书来到南京邮电大学现代邮政学院报道那天的懵懂与憧憬，一路走来，很荣 幸结识到很多求真务实的导师和热情温暖的师兄师姐和同学们，在学业上收获了很多专业知 识，在实践上进入校企合作企业学习到很多技术和团队合作沟通技巧，这些收获让我的三年 学习生活变得多姿多彩。在这里，我由衷地向各位导师、师兄师姐、同学们表达我诚挚的谢 意。
首先我要感谢我的导师孙知信老师和宫婧老师。感谢孙知信老师让我参与的很多个研究 领域的项目，这对我提升自己的履历和技术掌握有很大的帮助，并让我接触写专利，在专利 和毕业论文的评讲过程中指导撰写的思路以及细节的处理，使得我可以顺利完成发明专利和 毕业论文。在参加的这些项目实践中，让我对计算机相关技术知识有了更多更深的认识以及 运用，让我对找工作和后续论文撰写充满激情。感谢宫婧老师在生活和学习上的关心与帮助， 提供给我很多学习方向以及学习建议。在毕业论文写作过程中，宫婧老师牺牲自己很多的时 间一遍一遍的审阅我的论文，并且悉心地和我讨论论文中的细节和逻辑，不断的提出修改建 议，从论文框架结构到逻辑，直到我的毕业论文的完成。平时生活中，宫婧老师也会关心我 的课程学习问题，在疫情期间也一直关心我的健康问题注意防护。非常荣幸遇到孙老师和宫 老师，感谢两位老师这三年的关心和教导，在今后的道路上我将铭记教诲不断努力下去。
其次还要感谢师门的赵学健老师和孙哲老师，在校企合作期间和专利撰写时对我的帮助 和关心，你们的倾情付出对我的成长有巨大帮助。我还要感谢同门的师兄师姐以及同学们， 帮助我一起探讨论文和专利，并给出自己的建议，让我少走弯路，不断对专利进行完善。感 谢 231、232、227 宿舍的伙伴们陪我一起度过了这三年的学习时光，一同学习，一起完成项 目，衷心祝福各位事业一帆风顺。
还要感谢我的父母和家人。感谢他们陪伴让我可以专心置身于科研学习之中，感谢他们 最温暖的鼓励和无私的奉献，今后，我会好好努力来撑起这个家来回报他们的爱，祝愿我的 家人身体健康长寿！
最后感谢负责审查本文的专家们对本文的指导与意见，祝愿你们万事如意，身体安康！

77

